/*
 Copyright (c) 2014, Pixel & Tonic, Inc.
 @license   http://buildwithcraft.com/license Craft License Agreement
 @link      http://buildwithcraft.com
*/
(function(c){"undefined"==typeof Craft&&(Craft={});c.extend(Craft,{navHeight:48,asciiCharMap:{223:"ss",224:"a",225:"a",226:"a",229:"a",227:"ae",230:"ae",228:"ae",231:"c",232:"e",233:"e",234:"e",235:"e",236:"i",237:"i",238:"i",239:"i",241:"n",242:"o",243:"o",244:"o",245:"o",246:"oe",249:"u",250:"u",251:"u",252:"ue",255:"y",257:"aa",269:"ch",275:"ee",291:"gj",299:"ii",311:"kj",316:"lj",326:"nj",353:"sh",363:"uu",382:"zh",256:"aa",268:"ch",274:"ee",290:"gj",298:"ii",310:"kj",315:"lj",325:"nj",352:"sh",
362:"uu",381:"zh"},t:function(a,b){"undefined"!=typeof Craft.translations[a]&&(a=Craft.translations[a]);if(b)for(var d in b)a=a.replace("{"+d+"}",b[d]);return a},escapeHtml:function(a){return c("<div/>").text(a).html()},getText:function(a){return c("<div/>").html(a).text()},encodeUriComponent:function(a){a=encodeURIComponent(a);var b={"!":"%21","*":"%2A","'":"%27","(":"%28",")":"%29"},d;for(d in b)a=a.replace(RegExp("\\"+d,"g"),b[d]);return a},formatInputId:function(a){return this.rtrim(a.replace(/[\[\]]+/g,
"-"),"-")},getUrl:function(a,b,d){"string"!=typeof a&&(a="");if(-1!=a.search("://")||"//"==a.substr(0,2))return a;a=Craft.trim(a,"/");var e="";if(c.isPlainObject(b)){var f=[],g;for(g in b){var h=b[g];"#"==g?e=h:null!==h&&""!==h&&f.push(g+"="+h)}b=f}b=Garnish.isArray(b)?b.join("&"):Craft.trim(b,"&?");f=a.indexOf("?");-1!=f&&(b=a.substr(f+1)+(b?"&"+b:""),a=a.substr(0,f));d?a&&(f=d.match(/[&\?]p=[^&]+/))&&(d=d.replace(f[0],f[0]+"/"+a),a=""):d=Craft.baseUrl;f=d.indexOf("?");"-1"!=f&&(b=d.substr(f+1)+
(b?"&"+b:""),d=d.substr(0,f));!Craft.omitScriptNameInUrls&&a&&(Craft.usePathInfo?-1==d.search(Craft.scriptName)&&(d=Craft.rtrim(d,"/")+"/"+Craft.scriptName):(b&&"p="==b.substr(0,2)&&(f=b.indexOf("&"),-1!=f?(g=b.substring(2,f),b=b.substr(f+1)):(g=b.substr(2),b=null),g=Craft.rtrim(g),a=g+(a?"/"+a:"")),b="p="+a+(b?"&"+b:""),a=null));a&&(d=Craft.rtrim(d,"/")+"/"+a);b&&(d+="?"+b);e&&(d+="#"+e);return d},getCpUrl:function(a,b){return this.getUrl(a,b,Craft.baseCpUrl)},getSiteUrl:function(a,b){return this.getUrl(a,
b,Craft.baseSiteUrl)},getResourceUrl:function(a,b){return Craft.getUrl(a,b,Craft.resourceUrl)},getActionUrl:function(a,b){return Craft.getUrl(a,b,Craft.actionUrl)},redirectTo:function(a){document.location.href=this.getUrl(a)},postActionRequest:function(a,b,d,e){"function"==typeof b&&(e=d,d=b,b=void 0);a=c.ajax(c.extend({url:Craft.getActionUrl(a),type:"POST",data:b,success:d,error:function(a,b,c){d&&d(null,b,a)},complete:function(a,b){"success"!=b&&("undefined"!=typeof Craft.cp?Craft.cp.displayError():
alert(Craft.t("An unknown error occurred.")))}},e));e&&"function"==typeof e.send&&e.send(a);return a},_waitingOnAjax:!1,_ajaxQueue:[],queueActionRequest:function(a,b,d,c){"function"==typeof b&&(c=d,d=b,b=void 0);Craft._ajaxQueue.push([a,b,d,c]);Craft._waitingOnAjax||Craft._postNextActionRequestInQueue()},_postNextActionRequestInQueue:function(){Craft._waitingOnAjax=!0;var a=Craft._ajaxQueue.shift();Craft.postActionRequest(a[0],a[1],function(b,d,c){if(a[2]&&"function"==typeof a[2])a[2](b,d,c);Craft._ajaxQueue.length?
Craft._postNextActionRequestInQueue():Craft._waitingOnAjax=!1},a[3])},stringToArray:function(a){if("string"!=typeof a)return a;a=a.split(",");for(var b=0;b<a.length;b++)a[b]=c.trim(a[b]);return a},expandPostArray:function(a){var b={},d;for(d in a){var c=a[d],f=d.match(/^(\w+)(\[.*)?/);if(f[2])for(var g=f[2].match(/\[[^\[\]]*\]/g),h=0;h<g.length;h++)g[h]=g[h].substring(1,g[h].length-1);else g=[];g.unshift(f[1]);f=b;for(h=0;h<g.length;h++)h<g.length-1?("object"!=typeof f[g[h]]&&(g[h+1]&&parseInt(g[h+
1])!=g[h+1]?f[g[h]]={}:f[g[h]]=[]),f=f[g[h]]):(g[h]||(g[h]=f.length),f[g[h]]=c)}return b},compare:function(a,b){if(typeof a!=typeof b)return!1;if("object"==typeof a){if(a.length!=b.length||a instanceof Array!=b instanceof Array||!(a instanceof Array||Craft.compare(Craft.getObjectKeys(a),Craft.getObjectKeys(b))))return!1;for(var d in a)if(!Craft.compare(a[d],b[d]))return!1;return!0}return a===b},getObjectKeys:function(a){var b=[],d;for(d in a)b.push(d);return b},escapeChars:function(a){Garnish.isArray(a)||
(a=a.split());for(var b="",d=0;d<a.length;d++)b+="\\"+a[d];return b},ltrim:function(a,b){if(!a)return a;void 0===b&&(b=" \t\n\r\x00\x0B");var d=RegExp("^["+Craft.escapeChars(b)+"]+");return a.replace(d,"")},rtrim:function(a,b){if(!a)return a;void 0===b&&(b=" \t\n\r\x00\x0B");var d=RegExp("["+Craft.escapeChars(b)+"]+$");return a.replace(d,"")},trim:function(a,b){a=Craft.ltrim(a,b);return a=Craft.rtrim(a,b)},filterArray:function(a,b){for(var d=[],c=0;c<a.length;c++)("function"==typeof b?b(a[c],c):a[c])&&
d.push(a[c]);return d},inArray:function(a,b){return-1!=c.inArray(a,b)},removeFromArray:function(a,b){var d=c.inArray(a,b);return-1!=d?(b.splice(d,1),!0):!1},getLast:function(a){return a.length?a[a.length-1]:null},uppercaseFirst:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},lowercaseFirst:function(a){return a.charAt(0).toLowerCase()+a.slice(1)},asciiString:function(a){for(var b="",d=0;d<a.length;d++){var c=a.charCodeAt(d);32<=c&&128>c?b+=a.charAt(d):"undefined"!=typeof Craft.asciiCharMap[c]&&
(b+=Craft.asciiCharMap[c])}return b},preventOutlineOnMouseFocus:function(a){var b=c(a);b.on("mousedown.preventOutlineOnMouseFocus",function(){b.addClass("no-outline");b.focus()}).on("keydown.preventOutlineOnMouseFocus blur.preventOutlineOnMouseFocus",function(a){a.keyCode!=Garnish.SHIFT_KEY&&a.keyCode!=Garnish.CTRL_KEY&&a.keyCode!=Garnish.CMD_KEY&&b.removeClass("no-outline")})},createErrorList:function(a){for(var b=c(document.createElement("ul")).addClass("errors"),d=0;d<a.length;d++){var e=c(document.createElement("li"));
e.appendTo(b);e.html(a[d])}return b},initUiElements:function(a){c(".grid",a).grid();c(".pane",a).pane();c(".info",a).infoicon();c(".checkbox-select",a).checkboxselect();c(".fieldtoggle",a).fieldtoggle();c(".lightswitch",a).lightswitch();c(".nicetext",a).nicetext();c(".pill",a).pill();c(".menubtn",a).menubtn();c("input[type!=password], textarea",a).placeholder()},_elementIndexClasses:{},_elementSelectorModalClasses:{},registerElementIndexClass:function(a,b){if("undefined"!=typeof this._elementIndexClasses[a])throw"An element index class has already been registered for the element type \u201c"+
a+"\u201d.";this._elementIndexClasses[a]=b},registerElementSelectorModalClass:function(a,b){if("undefined"!=typeof this._elementSelectorModalClasses[a])throw"An element selector modal class has already been registered for the element type \u201c"+a+"\u201d.";this._elementSelectorModalClasses[a]=b},createElementIndex:function(a,b,d){return new ("undefined"!=typeof this._elementIndexClasses[a]?this._elementIndexClasses[a]:Craft.BaseElementIndex)(a,b,d)},createElementSelectorModal:function(a,b){return new ("undefined"!=
typeof this._elementSelectorModalClasses[a]?this._elementSelectorModalClasses[a]:Craft.BaseElementSelectorModal)(a,b)},getLocalStorage:function(a,b){a="Craft-"+Craft.siteUid+"."+a;return"undefined"!=typeof localStorage&&"undefined"!=typeof localStorage[a]?JSON.parse(localStorage[a]):b},setLocalStorage:function(a,b){"undefined"!=typeof localStorage&&(a="Craft-"+Craft.siteUid+"."+a,localStorage[a]=JSON.stringify(b))},getElementInfo:function(a){a=c(a);a.hasClass("element")||(a=a.find(".element:first"));
return{id:a.data("id"),label:a.data("label"),status:a.data("status"),url:a.data("url"),hasThumb:a.hasClass("hasthumb"),$element:a}},showElementEditor:function(a){!a.data("editable")||a.hasClass("disabled")||a.hasClass("loading")||new Craft.ElementEditor(a)}});c.extend(c.fn,{animateLeft:function(a,b,d,c){return"ltr"==Craft.orientation?this.animate({left:a},b,d,c):this.animate({right:a},b,d,c)},animateRight:function(a,b,d,c){return"ltr"==Craft.orientation?this.animate({right:a},b,d,c):this.animate({left:a},
b,d,c)},disable:function(){return this.each(function(){var a=c(this);a.addClass("disabled");a.data("activatable")&&a.removeAttr("tabindex")})},enable:function(){return this.each(function(){var a=c(this);a.removeClass("disabled");a.data("activatable")&&a.attr("tabindex","0")})},grid:function(){return this.each(function(){var a=c(this),b={};a.data("item-selector")&&(b.itemSelector=a.data("item-selector"));a.data("cols")&&(b.cols=parseInt(a.data("cols")));a.data("min-col-width")&&(b.minColWidth=parseInt(a.data("min-col-width")));
a.data("mode")&&(b.mode=a.data("mode"));a.data("fill-mode")&&(b.fillMode=a.data("fill-mode"));a.data("col-class")&&(b.colClass=a.data("col-class"));a.data("snap-to-grid")&&(b.snapToGrid=!!a.data("snap-to-grid"));new Craft.Grid(this,b)})},infoicon:function(){return this.each(function(){new Craft.InfoIcon(this)})},pane:function(){return this.each(function(){new Craft.Pane(this)})},checkboxselect:function(){return this.each(function(){c.data(this,"checkboxselect")||new Garnish.CheckboxSelect(this)})},
fieldtoggle:function(){return this.each(function(){c.data(this,"fieldtoggle")||new Craft.FieldToggle(this)})},lightswitch:function(a,b,d){return"settings"==a?("string"==typeof b?(a={},a[b]=d):a=b,this.each(function(){var b=c.data(this,"lightswitch");b&&b.setSettings(a)})):this.each(function(){c.data(this,"lightswitch")||new Craft.LightSwitch(this,a)})},nicetext:function(){return this.each(function(){c.data(this,"text")||new Garnish.NiceText(this)})},pill:function(){return this.each(function(){c.data(this,
"pill")||new Garnish.Pill(this)})},menubtn:function(){return this.each(function(){var a=c(this);!a.data("menubtn")&&a.next().hasClass("menu")&&new Garnish.MenuBtn(a)})}});Garnish.$doc.ready(function(){Craft.initUiElements()});Craft.BaseElementIndex=Garnish.Base.extend({elementType:null,instanceState:null,sourceStates:null,sourceStatesStorageKey:null,searchTimeout:null,elementSelect:null,sourceSelect:null,$container:null,$main:null,$scroller:null,$toolbar:null,$search:null,$mainSpinner:null,$statusMenuBtn:null,
statusMenu:null,status:null,$localeMenuBtn:null,localeMenu:null,locale:null,$viewModeBtnTd:null,$viewModeBtnContainer:null,viewModeBtns:null,viewMode:null,$loadingMoreSpinner:null,$sidebar:null,$sidebarButtonContainer:null,showingSidebar:null,$sources:null,sourceKey:null,sourceViewModes:null,$source:null,$sourceToggles:null,$elements:null,$table:null,$elementContainer:null,init:function(a,b,d){this.elementType=a;this.$container=b;this.setSettings(d,Craft.BaseElementIndex.defaults);this.instanceState=
{selectedSource:null};this.sourceStates={};this.settings.storageKey&&c.extend(this.instanceState,Craft.getLocalStorage(this.settings.storageKey),{});this.sourceStatesStorageKey="BaseElementIndex."+this.elementType+"."+this.settings.context;c.extend(this.sourceStates,Craft.getLocalStorage(this.sourceStatesStorageKey,{}));this.$main=this.$container.find(".main");this.$toolbar=this.$container.find(".toolbar:first");this.$statusMenuBtn=this.$toolbar.find(".statusmenubtn:first");this.$localeMenuBtn=this.$toolbar.find(".localemenubtn:first");
this.$search=this.$toolbar.find(".search:first input:first");this.$mainSpinner=this.$toolbar.find(".spinner:first");this.$loadingMoreSpinner=this.$container.find(".spinner.loadingmore");this.$sidebar=this.$container.find(".sidebar:first");this.$sidebarButtonContainer=this.$sidebar.children(".buttons");this.$sources=this.$sidebar.find("nav a");this.$sourceToggles=this.$sidebar.find(".toggle");this.$elements=this.$container.find(".elements:first");this.$sidebarButtonContainer.length||(this.$sidebarButtonContainer=
c('<div class="buttons"/>').prependTo(this.$sidebar));this.showingSidebar=this.$sidebar.length&&!this.$sidebar.hasClass("hidden");this.$viewModeBtnTd=this.$toolbar.find(".viewbtns:first");this.$viewModeBtnContainer=c('<div class="btngroup"/>').appendTo(this.$viewModeBtnTd);if(0!=this.$sources.length){this.$localeMenuBtn.length&&(this.localeMenu=this.$localeMenuBtn.menubtn().data("menubtn").menu,a=this.localeMenu.$options.filter(".sel:first"),a.length||(a=this.localeMenu.$options.first()),a.length?
this.locale=a.data("locale"):this.settings.criteria={id:"0"},this.localeMenu.on("optionselect",c.proxy(this,"onLocaleChange")));this.onAfterHtmlInit();this.$scroller="index"==this.settings.context?Garnish.$win:this.$main;if(a=this.getDefaultSourceKey()){var e=this.getSourceByKey(a);e&&e.parentsUntil(".sidebar","li").not(":first").addClass("expanded")}a&&e||(e=this.$sources.first());this.selectSource(e);this.updateElements();this.addListener(this.$sourceToggles,"click",function(a){c(a.currentTarget).parent().toggleClass("expanded");
this.$sidebar.trigger("resize");a.stopPropagation()});this.sourceSelect=new Garnish.Select(this.$sidebar.find("nav"),this.$sources,{selectedClass:"sel",multi:!1,vertical:!0,onSelectionChange:c.proxy(this,"onSourceSelectionChange")});this.$statusMenuBtn.length&&(this.statusMenu=this.$statusMenuBtn.menubtn().data("menubtn").menu,this.statusMenu.on("optionselect",c.proxy(this,"onStatusChange")));this.addListener(this.$search,"textchange",c.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout);
this.searchTimeout=setTimeout(c.proxy(this,"updateElements"),500)},this));Garnish.isMobileBrowser(!0)||this.$search.focus()}},getDefaultSourceKey:function(){return this.instanceState.selectedSource},onSourceSelectionChange:function(){var a=this.$sources.filter(".sel");0==a.length&&(a=this.$sources.filter(":first"));this.selectSource(a);this.updateElements()},setInstanceState:function(a,b){"object"==typeof a?c.extend(this.instanceState,a):this.instanceState[a]=b;this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,
this.instanceState)},getSourceState:function(a,b,d){"undefined"==typeof this.sourceStates[a]&&(this.sourceStates[a]={});return"undefined"==typeof b?this.sourceStates[a]:"undefined"!=typeof this.sourceStates[a][b]?this.sourceStates[a][b]:"undefined"!=typeof d?d:null},getSelectedSourceState:function(a,b){return this.getSourceState(this.instanceState.selectedSource,a,b)},setSelecetedSourceState:function(a,b){var d=this.getSelectedSourceState();"object"==typeof a?c.extend(d,a):d[a]=b;this.sourceStates[this.instanceState.selectedSource]=
d;Craft.setLocalStorage(this.sourceStatesStorageKey,this.sourceStates)},getControllerData:function(){return{context:this.settings.context,elementType:this.elementType,criteria:c.extend({status:this.status,locale:this.locale},this.settings.criteria),disabledElementIds:this.settings.disabledElementIds,source:this.instanceState.selectedSource,status:this.status,viewState:this.getSelectedSourceState(),search:this.$search?this.$search.val():null}},updateElements:function(){this.$mainSpinner.removeClass("hidden");
this.removeListener(this.$scroller,"scroll");"table"==this.getSelectedSourceState("mode")&&this.$table&&(Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.not(this.$table));this.$search&&this.$search.val()?"structure"==this.getSelectedSourceState("mode")&&this.selectViewMode("table",!0):"table"!=this.getSelectedSourceState("mode")||this.doesSourceHaveViewMode("table")||this.selectViewMode(this.sourceViewModes[0].mode,!0);var a=this.getControllerData();Craft.postActionRequest("elements/getElements",
a,c.proxy(function(a,d){this.$mainSpinner.addClass("hidden");"success"==d&&this.setNewElementDataHtml(a,!1)},this))},setNewElementDataHtml:function(a,b){if(b)this.$elementContainer.append(a.html);else{this.$elements.html(a.html);this.$scroller.scrollTop(0);if("table"==this.getSelectedSourceState("mode")){var d=this.$elements.find("thead:first th");this.addListener(d,"click","onSortChange");this.$table=this.$elements.find("table:first");Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.add(this.$table)}this.$elementContainer=
this.getElementContainer()}c("head").append(a.headHtml);Garnish.$bod.append(a.footHtml);a.more&&(this.totalVisible=a.totalVisible,this.addListener(this.$scroller,"scroll",function(){if(this.$scroller[0]==Garnish.$win[0])var a=Garnish.$win.innerHeight(),b=Garnish.$win.scrollTop(),d=Garnish.$bod.height(),a=a+b>=d;else{var b=this.$scroller.prop("scrollHeight"),d=this.$scroller.scrollTop(),h=this.$scroller.outerHeight(),a=b-d<=h+15;console.log(b,d,h,a)}a&&(this.$loadingMoreSpinner.removeClass("hidden"),
this.removeListener(this.$scroller,"scroll"),a=this.getControllerData(),a.offset=this.totalVisible,Craft.postActionRequest("elements/getElements",a,c.proxy(function(a,b){this.$loadingMoreSpinner.addClass("hidden");"success"==b&&this.setNewElementDataHtml(a,!0)},this)))}));"table"==this.getSelectedSourceState("mode")&&Craft.cp.updateResponsiveTables();this.onUpdateElements(b)},getElementContainer:function(){return"table"==this.getSelectedSourceState("mode")?this.$table.find("tbody:first"):this.$elements.children("ul")},
onUpdateElements:function(a){this.settings.onUpdateElements(a)},onStatusChange:function(a){this.statusMenu.$options.removeClass("sel");a=c(a.selectedOption).addClass("sel");this.$statusMenuBtn.html(a.html());this.status=a.data("status");this.updateElements()},onLocaleChange:function(a){this.localeMenu.$options.removeClass("sel");a=c(a.selectedOption).addClass("sel");this.$localeMenuBtn.html(a.html());this.locale=a.data("locale");this.updateElements()},onSortChange:function(a){a=c(a.currentTarget).attr("data-attribute");
this.getSelectedSourceState("order")==a?"asc"==this.getSelectedSourceState("sort")?this.setSelecetedSourceState("sort","desc"):this.setSelecetedSourceState("sort","asc"):this.setSelecetedSourceState({order:a,sort:"asc"});this.updateElements()},getSourceByKey:function(a){for(var b=0;b<this.$sources.length;b++){var d=c(this.$sources[b]);if(d.data("key")==a)return d}},selectSource:function(a){if(this.$source!=a){this.$source&&this.$source.removeClass("sel");this.sourceKey=a.data("key");this.$source=
a.addClass("sel");this.setInstanceState("selectedSource",this.sourceKey);this.$search&&(this.$search.data("textchangeValue",""),this.$search.val(""));this.$viewModeBtnContainer.empty();this.viewModeBtns={};this.viewMode=null;this.sourceViewModes=this.getViewModesForSource();if(1<this.sourceViewModes.length)for(this.$viewModeBtnTd.removeClass("hidden"),a=0;a<this.sourceViewModes.length;a++){var b=this.sourceViewModes[a],d=c('<div data-view="'+b.mode+'" role="button" class="btn'+("undefined"!=typeof b.className?
" "+b.className:"")+'" title="'+b.title+'"'+("undefined"!=typeof b.icon?' data-icon="'+b.icon+'"':"")+"/>").appendTo(this.$viewModeBtnContainer);this.viewModeBtns[b.mode]=d;this.addListener(d,"click",{mode:b.mode},function(a){this.selectViewMode(a.data.mode);this.updateElements()})}else this.$viewModeBtnTd.addClass("hidden");(b=this.getSelectedSourceState("mode"))&&this.doesSourceHaveViewMode(b)||(b=this.$source.data("has-structure")?"structure":this.viewMode&&this.doesSourceHaveViewMode(this.viewMode)?
this.viewMode:this.sourceViewModes[0].mode);this.selectViewMode(b);this.onSelectSource()}},getViewModesForSource:function(){var a=[{mode:"table",title:Craft.t("Display in a table"),icon:"list"}];this.$source.data("has-structure")&&a.push({mode:"structure",title:Craft.t("Display hierarchically"),icon:"structure"});this.$source.data("has-thumbs")&&a.push({mode:"thumbs",title:Craft.t("Display as thumbnails"),icon:"grid"});return a},onSelectSource:function(){this.settings.onSelectSource(this.sourceKey)},
onAfterHtmlInit:function(){this.settings.onAfterHtmlInit()},doesSourceHaveViewMode:function(a){for(var b=0;b<this.sourceViewModes.length;b++)if(this.sourceViewModes[b].mode==a)return!0;return!1},selectViewMode:function(a,b){b||this.doesSourceHaveViewMode(a)||(a=this.sourceViewModes[0].mode);a!=this.viewMode&&(this.viewMode&&"undefined"!=typeof this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].removeClass("active"),this.viewMode=a,this.setSelecetedSourceState("mode",this.viewMode),
"undefined"!=typeof this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].addClass("active"))},rememberDisabledElementId:function(a){-1==c.inArray(a,this.settings.disabledElementIds)&&this.settings.disabledElementIds.push(a)},forgetDisabledElementId:function(a){a=c.inArray(a,this.settings.disabledElementIds);-1!=a&&this.settings.disabledElementIds.splice(a,1)},enableElements:function(a){a.removeClass("disabled").parents(".disabled").removeClass("disabled");for(var b=0;b<a.length;b++){var d=
c(a[b]).data("id");this.forgetDisabledElementId(d)}this.settings.onEnableElements(a)},disableElements:function(a){a.removeClass("sel").addClass("disabled").parent().removeClass("sel");for(var b=0;b<a.length;b++){var d=c(a[b]).data("id");this.rememberDisabledElementId(d)}this.settings.onDisableElements(a)},getElementById:function(a){return this.$elementContainer.find("[data-id="+a+"]:first")},enableElementsById:function(a){a=c.makeArray(a);for(var b=0;b<a.length;b++){var d=a[b],e=this.getElementById(d);
e.length?this.enableElements(e):this.forgetDisabledElementId(d)}},disableElementsById:function(a){a=c.makeArray(a);for(var b=0;b<a.length;b++){var d=a[b],e=this.getElementById(d);e.length?this.disableElements(e):this.rememberDisabledElementId(d)}},setElementSelect:function(a){this.elementSelect=a},addButton:function(a){this.showingSidebar?this.$sidebarButtonContainer.append(a):c('<td class="thin"/>').prependTo(this.$toolbar.find("tr:first")).append(a)},addCallback:function(a,b){return c.proxy(function(){"function"==
typeof a&&a.apply(this,arguments);b.apply(this,arguments)},this)},setIndexBusy:function(){this.$mainSpinner.removeClass("hidden");this.isIndexBusy=!0;this.$elements.fadeTo("fast",0.5)},setIndexAvailable:function(){this.$mainSpinner.addClass("hidden");this.isIndexBusy=!1;this.$elements.fadeTo("fast",1)}},{defaults:{context:"index",storageKey:null,criteria:null,disabledElementIds:[],onUpdateElements:c.noop,onEnableElements:c.noop,onDisableElements:c.noop,onSelectSource:c.noop,onAfterHtmlInit:c.noop}});
Craft.BaseElementSelectInput=Garnish.Base.extend({id:null,name:null,elementType:null,sources:null,criteria:null,sourceElementId:null,limit:null,modalStorageKey:null,elementSelect:null,elementSort:null,modal:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,selectable:!0,sortable:!0,init:function(a,b,d,e,f,g,h,k){this.id=a;this.name=b;this.elementType=d;this.sources=e;this.criteria=f;this.sourceElementId=g;this.limit=h;k&&(this.modalStorageKey="BaseElementSelectInput."+
k);this.$container=this.getContainer();this.$elementsContainer=this.getElementsContainer();this.$elements=this.getElements();this.$addElementBtn=this.getAddElementsBtn();this.updateAddElementsBtn();this.selectable&&(this.elementSelect=new Garnish.Select(this.$elements,{multi:!0,filter:":not(.delete)"}));this.sortable&&(this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:this.selectable?c.proxy(function(){return this.elementSelect.getSelectedItems()},this):null,caboose:c('<div class="caboose"/>'),
onSortChange:this.selectable?c.proxy(function(){this.elementSelect.resetItemOrder()},this):null}));this.initElements(this.$elements);this.addListener(this.$addElementBtn,"activate","showModal")},getContainer:function(){return c("#"+this.id)},getElementsContainer:function(){return this.$container.children(".elements")},getElements:function(){return this.$elementsContainer.children()},getAddElementsBtn:function(){return this.$container.children(".btn.add")},canAddMoreElements:function(){return!this.limit||
this.$elements.length<this.limit},updateAddElementsBtn:function(){this.canAddMoreElements()?this.enableAddElementsBtn():this.disableAddElementsBtn()},disableAddElementsBtn:function(){this.$addElementBtn.addClass("disabled")},enableAddElementsBtn:function(){this.$addElementBtn.removeClass("disabled")},initElements:function(a){this.selectable&&this.elementSelect.addItems(a);this.sortable&&this.elementSort.addItems(a);a.find(".delete").on("click",c.proxy(function(a){this.removeElement(c(a.currentTarget).closest(".element"))},
this));this.addListener(a,"dblclick",function(a){Craft.showElementEditor(c(a.currentTarget))})},removeElement:function(a){var b=c(a);this.$elements=this.$elements.not(b);this.selectable&&this.elementSelect.removeItems(b);this.modal&&b.data("id")&&this.modal.elementIndex.enableElementsById(b.data("id"));this.$addElementBtn&&this.$addElementBtn.length&&this.updateAddElementsBtn();b.css("z-index",0);a={opacity:-1};a["margin-"+Craft.left]=-(b.outerWidth()+parseInt(b.css("margin-"+Craft.right)));b.animate(a,
"fast",function(){b.remove()})},showModal:function(){this.canAddMoreElements()&&(this.modal?this.modal.show():this.modal=this.createModal())},createModal:function(){return Craft.createElementSelectorModal(this.elementType,{storageKey:this.modalStorageKey,sources:this.sources,criteria:this.criteria,multiSelect:1!=this.limit,disabledElementIds:this.getSelectedElementIds(),onSelect:c.proxy(this,"onModalSelect")})},getSelectedElementIds:function(){var a=[];this.sourceElementId&&a.push(this.sourceElementId);
for(var b=0;b<this.$elements.length;b++)a.push(c(this.$elements[b]).data("id"));return a},onModalSelect:function(a){if(this.limit){var b=this.limit-this.$elements.length;a.length>b&&(a=a.slice(0,b))}this.selectElements(a);this.modal.elementIndex&&this.modal.elementIndex.disableElementsById(this.getSelectedElementIds())},selectElements:function(a){for(var b=0;b<a.length;b++){var d=a[b],e=this.createNewElement(d),d=d.$element.offset(),f=e.offset(),g={top:d.top-f.top,zIndex:1E4};g[Craft.left]=d.left-
f.left;e.css(g);d={top:0};d[Craft.left]=0;e.animate(d,function(){c(this).css("z-index",1)});this.initElements(e);this.$elements=this.$elements.add(e)}this.updateAddElementsBtn();this.onSelectElements()},createNewElement:function(a){var b=a.$element.clone();b.addClass("removable");b.prepend('<input type="hidden" name="'+this.name+'[]" value="'+a.id+'"><a class="delete icon" title="'+Craft.t("Remove")+'"></a>');b.appendTo(this.$elementsContainer);return b},onSelectElements:function(){this.trigger("selectElements")},
forceModalRefresh:function(){this.modal&&(this.modal.elementIndex=null)}});Craft.BaseElementSelectorModal=Garnish.Modal.extend({elementType:null,elementIndex:null,elementSelect:null,$body:null,$selectBtn:null,$sidebar:null,$sources:null,$sourceToggles:null,$main:null,$search:null,$elements:null,$tbody:null,$buttons:null,$cancelBtn:null,$selectBtn:null,init:function(a,b){this.elementType=a;this.setSettings(b,Craft.BaseElementSelectorModal.defaults);var d=c('<div class="modal elementselectormodal"></div>').appendTo(Garnish.$bod),
e=c('<div class="body"><div class="spinner big"></div></div>').appendTo(d),f=c('<div class="footer"/>').appendTo(d);this.base(d,this.settings);this.$buttons=c('<div class="buttons rightalign"/>').appendTo(f);this.$cancelBtn=c('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(this.$buttons);this.$selectBtn=c('<div class="btn disabled submit">'+Craft.t("Select")+"</div>").appendTo(this.$buttons);this.$body=e;this.addListener(this.$cancelBtn,"activate","cancel");this.addListener(this.$selectBtn,
"activate","selectElements")},onFadeIn:function(){this.elementIndex?Garnish.isMobileBrowser(!0)||this.elementIndex.$search.focus():Craft.postActionRequest("elements/getModalBody",{context:"modal",elementType:this.elementType,sources:this.settings.sources},c.proxy(function(a,b){"success"==b&&(this.$body.html(a),this.$body.has(".sidebar:not(.hidden)").length&&this.$body.addClass("has-sidebar"),this.elementIndex=Craft.createElementIndex(this.elementType,this.$body,{context:"modal",storageKey:this.settings.storageKey,
criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,onUpdateElements:c.proxy(this,"onUpdateElements"),onEnableElements:c.proxy(this,"onEnableElements"),onDisableElements:c.proxy(this,"onDisableElements")}))},this));this.base()},onUpdateElements:function(a){a||this.addListener(this.elementIndex.$elementContainer,"dblclick","selectElements");this.elementSelect&&(this.elementSelect.destroy(),delete this.elementSelect);a="structure"==this.elementIndex.getSelectedSourceState("mode")?
this.elementIndex.$elementContainer.find(".row:not(.disabled)"):this.elementIndex.$elementContainer.children(":not(.disabled)");this.elementSelect=new Garnish.Select(this.elementIndex.$elementContainer,a,{multi:this.settings.multiSelect,vertical:"thumbs"!=this.elementIndex.getSelectedSourceState("mode"),onSelectionChange:c.proxy(this,"onSelectionChange")});this.elementIndex.setElementSelect(this.elementSelect)},onSelectionChange:function(){this.elementSelect.totalSelected?this.$selectBtn.removeClass("disabled"):
this.$selectBtn.addClass("disabled")},onEnableElements:function(a){this.elementSelect.addItems(a)},onDisableElements:function(a){this.elementSelect.removeItems(a)},cancel:function(){this.hide()},selectElements:function(){if(this.elementIndex&&this.elementSelect&&this.elementSelect.totalSelected){this.elementSelect.clearMouseUpTimeout();this.hide();var a=this.elementSelect.getSelectedItems(),a=this.getElementInfo(a);this.onSelect(a);this.settings.disableOnSelect&&this.elementIndex.disableElements(this.elementSelect.getSelectedItems())}},
getElementInfo:function(a){for(var b=[],d=0;d<a.length;d++){var e=c(a[d]);b.push(Craft.getElementInfo(e))}return b},onSelect:function(a){this.settings.onSelect(a)}},{defaults:{resizable:!0,storageKey:null,sources:null,criteria:null,multiSelect:!1,disabledElementIds:[],disableOnSelect:!1,onCancel:c.noop,onSelect:c.noop}});Craft.BaseInputGenerator=Garnish.Base.extend({$source:null,$target:null,settings:null,listening:null,timeout:null,init:function(a,b,d){this.$source=c(a);this.$target=c(b);this.setSettings(d);
this.startListening()},setNewSource:function(a){var b=this.listening;this.stopListening();this.$source=c(a);b&&this.startListening()},startListening:function(){this.listening||(this.listening=!0,this.addListener(this.$source,"textchange","onTextChange"),this.addListener(this.$target,"focus",function(){this.addListener(this.$target,"textchange","stopListening");this.addListener(this.$target,"blur",function(){this.removeListener(this.$target,"textchange,blur")})}))},stopListening:function(){this.listening&&
(this.listening=!1,this.removeAllListeners(this.$source),this.removeAllListeners(this.$target))},onTextChange:function(){this.timeout&&clearTimeout(this.timeout);this.timeout=setTimeout(c.proxy(this,"updateTarget"),250)},updateTarget:function(){var a=this.$source.val(),a=this.generateTargetValue(a);this.$target.val(a);this.$target.trigger("textchange")},generateTargetValue:function(a){return a}});Craft.AdminTable=Garnish.Base.extend({settings:null,totalObjects:null,sorter:null,$noObjects:null,$table:null,
$tbody:null,$deleteBtns:null,init:function(a){this.setSettings(a,Craft.AdminTable.defaults);this.settings.allowDeleteAll||(this.settings.minObjects=1);this.$noObjects=c(this.settings.noObjectsSelector);this.$table=c(this.settings.tableSelector);this.$tbody=this.$table.children("tbody");this.totalObjects=this.$tbody.children().length;this.settings.sortable&&(this.sorter=new Craft.DataTableSorter(this.$table,{onSortChange:c.proxy(this,"reorderObjects")}));this.$deleteBtns=this.$table.find(".delete");
this.addListener(this.$deleteBtns,"click","deleteObject");this.updateUI()},addRow:function(a){if(!(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects)){a=c(a).appendTo(this.$tbody);var b=a.find(".delete");this.settings.sortable&&this.sorter.addItems(a);this.$deleteBtns=this.$deleteBtns.add(b);this.addListener(b,"click","deleteObject");this.totalObjects++;this.updateUI()}},reorderObjects:function(){if(!this.settings.sortable)return!1;for(var a=[],b=0;b<this.sorter.$items.length;b++){var d=
c(this.sorter.$items[b]).attr(this.settings.idAttribute);a.push(d)}a={ids:JSON.stringify(a)};Craft.postActionRequest(this.settings.reorderAction,a,c.proxy(function(a,b){"success"==b&&(a.success?Craft.cp.displayNotice(Craft.t(this.settings.reorderSuccessMessage)):Craft.cp.displayError(Craft.t(this.settings.reorderFailMessage)))},this))},deleteObject:function(a){if(!(this.settings.minObjects&&this.totalObjects<=this.settings.minObjects)){var b=c(a.target).closest("tr"),d=b.attr(this.settings.idAttribute),
e=b.attr(this.settings.nameAttribute);this.confirmDeleteObject(b)&&Craft.postActionRequest(this.settings.deleteAction,{id:d},c.proxy(function(a,c){"success"==c&&(a.success?(b.remove(),this.totalObjects--,this.updateUI(),this.onDeleteObject(d),Craft.cp.displayNotice(Craft.t(this.settings.deleteSuccessMessage,{name:e}))):Craft.cp.displayError(Craft.t(this.settings.deleteFailMessage,{name:e})))},this))}},confirmDeleteObject:function(a){a=a.attr(this.settings.nameAttribute);return confirm(Craft.t(this.settings.confirmDeleteMessage,
{name:a}))},onDeleteObject:function(a){this.settings.onDeleteObject(a)},updateUI:function(){0==this.totalObjects?(this.$table.hide(),this.$noObjects.removeClass("hidden")):(this.$table.show(),this.$noObjects.addClass("hidden"));if(this.settings.sortable){var a=this.$table.find(".move");1==this.totalObjects?a.addClass("disabled"):a.removeClass("disabled")}this.settings.minObjects&&this.totalObjects<=this.settings.minObjects?this.$deleteBtns.addClass("disabled"):this.$deleteBtns.removeClass("disabled");
this.settings.newObjectBtnSelector&&(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects?c(this.settings.newObjectBtnSelector).addClass("hidden"):c(this.settings.newObjectBtnSelector).removeClass("hidden"))}},{defaults:{tableSelector:null,noObjectsSelector:null,newObjectBtnSelector:null,idAttribute:"data-id",nameAttribute:"data-name",sortable:!1,allowDeleteAll:!0,minObjects:0,maxObjects:null,reorderAction:null,deleteAction:null,reorderSuccessMessage:Craft.t("New order saved."),reorderFailMessage:Craft.t("Couldn\u2019t save new order."),
confirmDeleteMessage:Craft.t("Are you sure you want to delete \u201c{name}\u201d?"),deleteSuccessMessage:Craft.t("\u201c{name}\u201d deleted."),deleteFailMessage:Craft.t("Couldn\u2019t delete \u201c{name}\u201d."),onDeleteObject:c.noop}});Craft.AssetIndex=Craft.BaseElementIndex.extend({$uploadButton:null,$uploadInput:null,$progressBar:null,$folders:null,$previouslySelectedFolder:null,uploader:null,promptHandler:null,progressBar:null,initialSourceKey:null,isIndexBusy:!1,_uploadTotalFiles:0,_uploadFileProgress:{},
_uploadedFileIds:[],_selectedFileIds:[],_singleFileMenu:null,_multiFileMenu:null,_fileDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],init:function(a,b,d){this.base(a,b,d);var e=this.settings.context;"index"==e&&this.initIndexMode();var f=this;this.$sources.each(function(){"index"==e?(f._createFolderContextMenu.apply(f,[c(this),!0]),1<c(this).parents("ul").length&&f._folderDrag.addItems(c(this).parent())):f._createFolderContextMenu.apply(f,[c(this),!1])})},initIndexMode:function(){var a=
this;this._fileDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:0.5,filter:c.proxy(function(){return this.elementSelect.getSelectedItems()},this),helper:c.proxy(function(a){return this._getDragHelper(a)},this),dropTargets:c.proxy(function(){var a=[];this.$sources.each(function(){a.push(c(this))});return a},this),onDragStart:c.proxy(function(){this._tempExpandedFolders=[];this.$previouslySelectedFolder=this.$source.removeClass("sel")},this),onDropTargetChange:c.proxy(this,
"_onDropTargetChange"),onDragStop:c.proxy(this,"_onFileDragStop")});this._folderDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:0.5,filter:c.proxy(function(){for(var a=this.sourceSelect.getSelectedItems(),d=[],e=0;e<a.length;e++){var f=c(a[e]).parent();1<f.parents("ul").length&&f.hasClass("sel")&&d.push(f[0])}return c(d)},this),helper:c.proxy(function(a){var d=c('<ul class="assets-fm-folderdrag" />').append(a);a.removeClass("expanded");d.width(this.$sidebar[0].scrollWidth);
return d},this),dropTargets:c.proxy(function(){var b=[];this.$sources.each(function(){c(this).is(a._folderDrag.$draggee)||b.push(c(this))});return b},this),onDragStart:c.proxy(function(){this._tempExpandedFolders=[];this._folderDrag.$draggee.filter(".expanded").removeClass("expanded").addClass("expanded-tmp")},this),onDropTargetChange:c.proxy(this,"_onDropTargetChange"),onDragStop:c.proxy(this,"_onFolderDragStop")})},_onFileDragStop:function(){if(this._fileDrag.$activeDropTarget){this._fileDrag.$activeDropTarget.addClass("sel");
for(var a=this._getFolderIdFromSourceKey(this._fileDrag.$activeDropTarget.data("key")),b=[],d=[],e=0;e<this._fileDrag.$draggee.length;e++){var f=Craft.getElementInfo(this._fileDrag.$draggee[e]).id,g=Craft.getElementInfo(this._fileDrag.$draggee[e]).url.split("/").pop();b.push(f);d.push(g)}if(b.length){this.setIndexBusy();this._positionProgressBar();this.progressBar.resetProgressBar();this.progressBar.setItemCount(b.length);this.progressBar.showProgressBar();for(var h=[],e=0;e<b.length;e++)h.push({fileId:b[e],
folderId:a,fileName:d[e]});var k=c.proxy(function(b){this.promptHandler.resetPrompts();for(var d=0;d<b.length;d++){var e=b[d];e.prompt&&this.promptHandler.addPrompt(e);e.error&&alert(e.error)}this.setIndexAvailable();this.progressBar.hideProgressBar();this.promptHandler.getPromptCount()?(b=c.proxy(function(b){for(var d=[],c=0;c<b.length;c++)if("cancel"!=b[c].choice)for(var e=0;e<h.length;e++)h[e].fileName==b[c].fileName&&(h[e].action=b[c].choice,d.push(h[e]));0==d.length?this._selectSourceByFolderId(a):
(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._moveFile(d,0,k))},this),this._fileDrag.fadeOutHelpers(),this.promptHandler.showBatchPrompts(b)):(this._fileDrag.fadeOutHelpers(),this._selectSourceByFolderId(a))},this);this._moveFile(h,0,k);return}}else this._collapseExtraExpandedFolders();this.$previouslySelectedFolder.addClass("sel");this._fileDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){this._folderDrag.$draggee.filter(".expanded-tmp").removeClass("expanded-tmp").addClass("expanded");
if(this._folderDrag.$activeDropTarget&&0==this._folderDrag.$activeDropTarget.siblings("ul").find(">li").filter(this._folderDrag.$draggee).length){var a=this._getFolderIdFromSourceKey(this._folderDrag.$activeDropTarget.data("key"));this._collapseExtraExpandedFolders(a);for(var b=[],d=0;d<this._folderDrag.$draggee.length;d++){var e=c("> a",this._folderDrag.$draggee[d]),e=this._getFolderIdFromSourceKey(e.data("key")),f=this._getSourceByFolderId(e);this._getFolderIdFromSourceKey(this._getParentSource(f).data("key"))!=
a&&b.push(e)}if(b.length){b.sort();b.reverse();this.setIndexBusy();this._positionProgressBar();this.progressBar.resetProgressBar();this.progressBar.setItemCount(b.length);this.progressBar.showProgressBar();for(var g=[],h=[],d=0;d<b.length;d++)h.push({folderId:b[d],parentId:a});this.requestId++;var k=[],m=[],l={},n=[],p=c.proxy(function(b){this.promptHandler.resetPrompts();for(var d=0;d<b.length;d++){var e=b[d];if(e.success&&e.transferList&&e.deleteList&&e.changedFolderIds){for(var f=0;f<e.transferList.length;f++)k.push(e.transferList[f]);
for(f=0;f<e.deleteList.length;f++)m.push(e.deleteList[f]);for(var g in e.changedFolderIds)l[g]=e.changedFolderIds[g];n.push(e.removeFromTree)}e.prompt&&this.promptHandler.addPrompt(e);e.error&&alert(e.error)}this.promptHandler.getPromptCount()?(b=c.proxy(function(a){this.promptHandler.resetPrompts();this.setNewElementDataHtml("");for(var b=[],d=0;d<a.length;d++)"cancel"!=a[d].choice&&(h[0].action=a[d].choice,b.push(h[0]));0==b.length?c.proxy(this,"_performActualFolderMove",k,m,l,n)():(this.setIndexBusy(),
this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),q(b,0,p))},this),this.promptHandler.showBatchPrompts(b),this.setIndexAvailable(),this.progressBar.hideProgressBar()):c.proxy(this,"_performActualFolderMove",k,m,l,n,a)()},this),q=c.proxy(function(a,b,d){0==b&&(g=[]);Craft.postActionRequest("assets/moveFolder",a[b],c.proxy(function(c,e){b++;this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();
"success"==e&&g.push(c);b>=a.length?d(g):q(a,b,d)},this))},this);q(h,0,p);return}}else this._collapseExtraExpandedFolders();this._folderDrag.returnHelpersToDraggees()},_performActualFolderMove:function(a,b,d,e,f){this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(1);this.progressBar.showProgressBar();var g=c.proxy(function(a,b,d){d=c();var e=c(),g;for(g in b)if(e=this._getSourceByFolderId(g),e=e.attr("data-key","folder:"+b[g].newId).data("key","folder:"+b[g].newId).parent(),
0==d.length||0<d.parents().filter(e).length)d=e,topFolderMovedId=b[g].newId;if(0==d.length)this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._folderDrag.returnHelpersToDraggees();else{b=d.find(">a");g=d.siblings("ul, .toggle");var e=this._getParentSource(b),p=this._getSourceByFolderId(f);this._prepareParentForChildren(p);this._addSubfolder(p,d);b.after(g);this._cleanUpTree(e);this.$sidebar.find("ul>ul, ul>.toggle").remove();for(d=0;d<a.length;d++)Craft.postActionRequest("assets/deleteFolder",
{folderId:a[d]});this.setIndexAvailable();this.progressBar.hideProgressBar();this._folderDrag.returnHelpersToDraggees();this._selectSourceByFolderId(topFolderMovedId)}},this);0<a.length?this._moveFile(a,0,c.proxy(function(){g(b,d,e)},this)):g(b,d,e)},_getParentSource:function(a){return 1==a.parents("ul").length?null:a.parent().parent().siblings("a")},_moveFile:function(a,b,d){0==b&&(this.responseArray=[]);Craft.postActionRequest("assets/moveFile",a[b],c.proxy(function(c,f){this.progressBar.incrementProcessedItemCount(1);
this.progressBar.updateProgressBar();"success"==f&&(this.responseArray.push(c),Craft.cp.runPendingTasks());b++;b>=a.length?d(this.responseArray):this._moveFile(a,b,d)},this))},_selectSourceByFolderId:function(a){a=this._getSourceByFolderId(a);a.parent().parents("li").each(function(){c(this).hasClass("expanded")||c(this).find("> .toggle").click()});this.selectSource(a);this.updateElements()},onAfterHtmlInit:function(){this.$uploadButton||(this.$uploadButton=c('<div class="btn submit assets-upload-button" data-icon="\u2191" style="position: relative; overflow: hidden;" role="button">'+
Craft.t("Upload files")+"</div>"),this.addButton(this.$uploadButton),this.$uploadInput=c('<input type="file" multiple="multiple" name="assets-upload" />').hide().insertBefore(this.$uploadButton));this.promptHandler=new Craft.PromptHandler;this.progressBar=new Craft.ProgressBar(this.$main,!0);var a={url:Craft.getActionUrl("assets/uploadFile"),fileInput:this.$uploadInput,dropZone:this.$main};a.events={fileuploadstart:c.proxy(this,"_onUploadStart"),fileuploadprogressall:c.proxy(this,"_onUploadProgress"),
fileuploaddone:c.proxy(this,"_onUploadComplete")};"undefined"!=typeof this.settings.criteria.kind&&(a.allowedKinds=this.settings.criteria.kind);this.uploader=new Craft.Uploader(this.$uploadButton,a);this.$uploadButton.on("click",c.proxy(function(){this.isIndexBusy||this.$uploadButton.parent().find("input[name=assets-upload]").click()},this));this.base()},onSelectSource:function(){this.uploader.setParams({folderId:this._getFolderIdFromSourceKey(this.sourceKey)});this.base()},_getFolderIdFromSourceKey:function(a){return a.split(":")[1]},
_onUploadStart:function(a){this.setIndexBusy();this._positionProgressBar();this.progressBar.resetProgressBar();this.progressBar.showProgressBar()},_onUploadProgress:function(a,b){var d=parseInt(100*(b.loaded/b.total),10);this.progressBar.setProgressPercentage(d)},_onUploadComplete:function(a,b){var d=b.result,e=b.files[0].name,f=!0;d.success||d.prompt?(this._uploadedFileIds.push(d.fileId),d.prompt&&this.promptHandler.addPrompt(d)):(d.error?alert(Craft.t("Upload failed for {filename}. The error message was: \u201d{error}\u201c",
{filename:e,error:d.error})):alert(Craft.t("Upload failed for {filename}.",{filename:e})),f=!1);this.uploader.isLastUpload()&&(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this.promptHandler.getPromptCount()?this.promptHandler.showBatchPrompts(c.proxy(this,"_uploadFollowup")):f&&this.updateElements())},_uploadFollowup:function(a){this.setIndexBusy();this.progressBar.resetProgressBar();this.promptHandler.resetPrompts();var b=c.proxy(function(){this.setIndexAvailable();this.progressBar.hideProgressBar();
this.updateElements()},this);this.progressBar.setItemCount(a.length);var d=c.proxy(function(a,b,g){Craft.postActionRequest("assets/uploadFile",{additionalInfo:a[b].additionalInfo,fileName:a[b].fileName,userResponse:a[b].choice},c.proxy(function(c,k){"success"==k&&c.fileId&&this._uploadedFileIds.push(c.fileId);b++;this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();b==a.length?g():d(a,b,g)},this))},this);this.progressBar.showProgressBar();d(a,0,b)},onUpdateElements:function(a){this.base(a);
"index"==this.settings.context&&($elements=this.$elementContainer.children(":not(.disabled)"),this._initElementSelect($elements),this._attachElementEvents($elements),this._initElementDragger($elements));if(this._uploadedFileIds.length){a=null;for(var b=0;b<this._uploadedFileIds.length;b++)a=this.$main.find("[data-id="+this._uploadedFileIds[b]+"]:first").parent(),"table"==this.getSelectedSourceState("mode")&&(a=a.parent()),this.elementSelect.selectItem(a);this._uploadedFileIds=[]}},_initElementSelect:function(a){"object"==
typeof this.elementSelect&&null!=this.elementSelect&&(this.elementSelect.destroy(),delete this.elementSelect);a=new Garnish.Select(this.$elementContainer,a,{multi:!0,vertical:"table"==this.getSelectedSourceState("mode"),onSelectionChange:c.proxy(this,"_onElementSelectionChange")});this.setElementSelect(a)},_onElementSelectionChange:function(){this._enableElementContextMenu();var a=this.elementSelect.getSelectedItems();this._selectedFileIds=[];for(var b=0;b<a.length;b++)this._selectedFileIds[b]=Craft.getElementInfo(a[b]).id},
_attachElementEvents:function(a){this.removeListener(a,"dlbclick");this.addListener(a,"dblclick",c.proxy(this,"_editProperties"));this._destroyElementContextMenus();this._createElementContextMenus(a)},_initElementDragger:function(a){this._fileDrag.removeAllItems();this._fileDrag.addItems(a)},_editProperties:function(a){a=c(a.currentTarget).find(".element");new Craft.ElementEditor(a)},_createElementContextMenus:function(a){var b={menuClass:"menu assets-contextmenu"},d=[{label:Craft.t("View file"),
onClick:c.proxy(this,"_viewFile")}];d.push({label:Craft.t("Edit properties"),onClick:c.proxy(this,"_showProperties")});d.push({label:Craft.t("Rename file"),onClick:c.proxy(this,"_renameFile")});d.push({label:Craft.t("Copy reference tag"),onClick:c.proxy(this,"_copyRefTag")});d.push("-");d.push({label:Craft.t("Delete file"),onClick:c.proxy(this,"_deleteFile")});this._singleFileMenu=new Garnish.ContextMenu(a,d,b);d=[{label:Craft.t("Delete"),onClick:c.proxy(this,"_deleteFiles")}];this._multiFileMenu=
new Garnish.ContextMenu(a,d,b);this._enableElementContextMenu()},_destroyElementContextMenus:function(){null!==this._singleFileMenu&&this._singleFileMenu.destroy();null!==this._multiFileMenu&&this._singleFileMenu.destroy()},_enableElementContextMenu:function(){this._multiFileMenu.disable();this._singleFileMenu.disable();1==this.elementSelect.getTotalSelected()?this._singleFileMenu.enable():1<this.elementSelect.getTotalSelected()&&this._multiFileMenu.enable()},_showProperties:function(a){c(a.currentTarget).dblclick()},
_viewFile:function(a){window.open(Craft.getElementInfo(a.currentTarget).url)},_renameFile:function(a){var b=c(a.currentTarget);a=Craft.getElementInfo(b).id;b=Craft.getElementInfo(b).url.split("/").pop();-1!==b.indexOf("?")&&(b=b.split("?").shift());var d=prompt(Craft.t("Rename file"),b);if(d&&d!=b){this.setIndexBusy();var e={fileId:a,folderId:this._getFolderIdFromSourceKey(this.$source.data("key")),fileName:d},f=function(a,b){this.setIndexAvailable();this.promptHandler.resetPrompts();if("success"==
b){if(a.prompt){this.promptHandler.addPrompt(a);var d=c.proxy(function(a){a=a[0].choice;"cancel"!=a&&(e.action=a,Craft.postActionRequest("assets/moveFile",e,c.proxy(f,this)))},this);this.promptHandler.showBatchPrompts(d)}a.success&&(this.updateElements(),Craft.cp.runPendingTasks());a.error&&alert(a.error)}};Craft.postActionRequest("assets/moveFile",e,c.proxy(f,this))}},_copyRefTag:function(a){var b=Craft.t("{ctrl}C to copy.",{ctrl:navigator.appVersion.indexOf("Mac")?"\u2318":"Ctrl-"});prompt(b,"{asset:"+
Craft.getElementInfo(c(a.currentTarget)).id+"}")},_deleteFile:function(a){a=c(a.currentTarget);var b=Craft.getElementInfo(a).id,d=Craft.getElementInfo(a).label;confirm(Craft.t("Are you sure you want to delete \u201c{name}\u201d?",{name:d}))&&(a.data("AssetEditor")&&a.data("AssetEditor").removeHud(),this.setIndexBusy(),Craft.postActionRequest("assets/deleteFile",{fileId:b},c.proxy(function(a,b){this.setIndexAvailable();"success"==b&&(a.error&&alert(a.error),this.updateElements())},this)))},_deleteFiles:function(){if(confirm(Craft.t("Are you sure you want to delete these {number} files?",
{number:this.elementSelect.getTotalSelected()}))){this.setIndexBusy();for(var a={},b=0;b<this._selectedFileIds.length;b++)a["fileId["+b+"]"]=this._selectedFileIds[b];Craft.postActionRequest("assets/deleteFile",a,c.proxy(function(a,b){this.setIndexAvailable();"success"==b&&(a.error&&alert(a.error),this.updateElements())},this))}},_getDragHelper:function(a){switch(this.getSelectedSourceState("mode")){case "table":var b=c('<div class="assets-listview assets-lv-drag" />'),d=c('<table cellpadding="0" cellspacing="0" border="0" />').appendTo(b),
e=c("<tbody />").appendTo(d);d.width(this.$table.width());e.append(a);return b;case "thumbs":return c('<ul class="thumbsview assets-tv-drag" />').append(a.removeClass("sel"))}return c()},_onDropTargetChange:function(a){clearTimeout(this._expandDropTargetFolderTimeout);a&&((a=this._getFolderIdFromSourceKey(a.data("key")))?(this.dropTargetFolder=this._getSourceByFolderId(a),this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)&&(this._expandDropTargetFolderTimeout=setTimeout(c.proxy(this,
"_expandFolder"),500))):this.dropTargetFolder=null)},_collapseExtraExpandedFolders:function(a){clearTimeout(this._expandDropTargetFolderTimeout);if(a)var b=this._getSourceByFolderId(a).parents("li").find(">a");for(var d=this._tempExpandedFolders.length-1;0<=d;d--){var c=this._tempExpandedFolders[d];a&&0!=b.filter('[data-key="'+c.data("key")+'"]').length||(this._collapseFolder(c),this._tempExpandedFolders.splice(d,1))}},_getSourceByFolderId:function(a){return this.$sources.filter('[data-key="folder:'+
a+'"]')},_hasSubfolders:function(a){return a.siblings("ul").find("li").length},_isExpanded:function(a){return a.parent("li").hasClass("expanded")},_expandFolder:function(){this._collapseExtraExpandedFolders(this._getFolderIdFromSourceKey(this.dropTargetFolder.data("key")));this.dropTargetFolder.parent().find("> .toggle").click();this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(a){a=a.parent();a.hasClass("expanded")&&a.find("> .toggle").click()},_createFolderContextMenu:function(a,
b){a=c(a);var d=[{label:Craft.t("New subfolder"),onClick:c.proxy(this,"_createSubfolder",a)}];1<a.parents("ul").length&&b&&(d.push({label:Craft.t("Rename folder"),onClick:c.proxy(this,"_renameFolder",a)}),d.push({label:Craft.t("Delete folder"),onClick:c.proxy(this,"_deleteFolder",a)}));new Garnish.ContextMenu(a,d,{menuClass:"menu assets-contextmenu"})},_createSubfolder:function(a){var b=prompt(Craft.t("Enter the name of the folder"));b&&(b={parentId:this._getFolderIdFromSourceKey(a.data("key")),folderName:b},
this.setIndexBusy(),Craft.postActionRequest("assets/createFolder",b,c.proxy(function(b,e){this.setIndexAvailable();if("success"==e&&b.success){this._prepareParentForChildren(a);var f=c('<li><a data-key="folder:'+b.folderId+'" data-has-thumbs="'+a.data("has-thumbs")+'">'+b.folderName+"</a></li>"),g=f.find("a");this._addSubfolder(a,f);this._createFolderContextMenu(g,"index"==this.settings.context);this.sourceSelect.addItems(g);this._folderDrag&&this._folderDrag.addItems(g.parent());this.$sources=this.$sources.add(g)}"success"==
e&&b.error&&alert(b.error)},this)))},_deleteFolder:function(a){if(confirm(Craft.t("Really delete folder \u201c{folder}\u201d?",{folder:c.trim(a.text())}))){var b={folderId:this._getFolderIdFromSourceKey(a.data("key"))};this.setIndexBusy();Craft.postActionRequest("assets/deleteFolder",b,c.proxy(function(b,c){this.setIndexAvailable();if("success"==c&&b.success){var f=this._getParentSource(a);this.$sources=this.$sources.not(a);this.sourceSelect.removeItems(a);a.parent().remove();this._cleanUpTree(f)}"success"==
c&&b.error&&alert(b.error)},this))}},_renameFolder:function(a){var b=c.trim(a.text()),d=prompt(Craft.t("Rename folder"),b);d&&d!=b&&(b={folderId:this._getFolderIdFromSourceKey(a.data("key")),newName:d},this.setIndexBusy(),Craft.postActionRequest("assets/renameFolder",b,c.proxy(function(b,d){this.setIndexAvailable();"success"==d&&b.success&&a.text(b.newName);"success"==d&&b.error&&alert(b.error)},this),"json"))},_prepareParentForChildren:function(a){this._hasSubfolders(a)||(a.parent().addClass("expanded").append('<div class="toggle"></div><ul></ul>'),
this.addListener(a.siblings(".toggle"),"click",function(a){c(a.currentTarget).parent().toggleClass("expanded")}))},_addSubfolder:function(a,b){var d=!1;a.siblings("ul").find(">li").each(function(){!d&&c.trim(c(this).text())>c.trim(b.text())&&(c(this).before(b),d=!0)});d||a.siblings("ul").append(b)},_cleanUpTree:function(a){null!==a&&0==a.siblings("ul").find("li").length&&(a.siblings("ul").remove(),a.siblings(".toggle").remove(),a.parent().removeClass("expanded"))},_positionProgressBar:function(){var a=
c(),a=0,a="index"==this.settings.context?this.progressBar.$progressBar.parents("#content"):this.progressBar.$progressBar.parents(".main"),b=a.offset().top,b=Garnish.$doc.scrollTop()-b,d=Garnish.$win.height(),a=a.height()>d?d/2-6+b:a.height()/2-6;this.progressBar.$progressBar.css({top:a})}});Craft.registerElementIndexClass("Asset",Craft.AssetIndex);Craft.AssetSelectInput=Craft.BaseElementSelectInput.extend({requestId:0,hud:null,fieldId:0,uploader:null,progressBar:null,init:function(a,b,d,c,f,g,h,k,
m){this.base(a,b,d,c,f,g,h,k);this.fieldId=m;this._attachDragEvents()},_attachDragEvents:function(){this.progressBar=new Craft.ProgressBar(c('<div class="progress-shade"></div>').appendTo(this.$container));var a={url:Craft.getActionUrl("assets/expressUpload"),dropZone:this.$container,formData:{fieldId:this.fieldId,entryId:c("input[name=entryId]").val()}};"undefined"!=typeof this.criteria.kind&&(a.allowedKinds=this.criteria.kind);a.events={};a.events.fileuploadstart=c.proxy(this,"_onUploadStart");
a.events.fileuploadprogressall=c.proxy(this,"_onUploadProgress");a.events.fileuploaddone=c.proxy(this,"_onUploadComplete");this.uploader=new Craft.Uploader(this.$container,a)},selectUploadedFile:function(a){if(!this.limit||this.totalElements+1!=this.limit){var b=a.$element;b.addClass("removable");b.prepend('<input type="hidden" name="'+this.name+'[]" value="'+a.id+'"><a class="delete icon" title="'+Craft.t("Remove")+'"></a>');b.appendTo(this.$elementsContainer);var d=-(b.outerWidth()+10);this.$addElementBtn.css("margin-"+
Craft.left,d+"px");d={};d["margin-"+Craft.left]=0;this.$addElementBtn.animate(d,"fast");this.$elements=this.$elements.add(b);this.initElements(b);this.totalElements++;this.limit&&this.totalElements==this.limit&&this.$addElementBtn.addClass("disabled");this.modal&&this.modal.elementIndex.rememberDisabledElementId(a.id)}},_onUploadStart:function(a){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6});this.$container.addClass("uploading");this.progressBar.resetProgressBar();
this.progressBar.showProgressBar()},_onUploadProgress:function(a,b){var d=parseInt(100*(b.loaded/b.total),10);this.progressBar.setProgressPercentage(d)},_onUploadComplete:function(a,b){var d=c(b.result.html);c("head").append(b.result.css);this.selectUploadedFile(Craft.getElementInfo(d));this.uploader.isLastUpload()&&(this.progressBar.hideProgressBar(),this.$container.removeClass("uploading"));this.forceModalRefresh()}});Craft.AssetSelectorModal=Craft.BaseElementSelectorModal.extend({$selectTransformBtn:null,
$transformSpinner:null,_selectedTransform:null,init:function(a,b){b=c.extend({},Craft.AssetSelectorModal.defaults,b);if(b.canSelectImageTransforms&&"undefined"==typeof Craft.AssetSelectorModal.transforms){var d=this.base;this.fetchTransformInfo(c.proxy(function(){d.call(this,a,b);this.createSelectTransformButton()},this))}else this.base(a,b),b.canSelectImageTransforms&&this.createSelectTransformButton()},fetchTransformInfo:function(a){Craft.postActionRequest("assets/getTransformInfo",c.proxy(function(b,
d){Craft.AssetSelectorModal.transforms="success"==d&&b instanceof Array?b:[];a()},this))},createSelectTransformButton:function(){if(Craft.AssetSelectorModal.transforms.length){var a=c('<div class="btngroup"/>').appendTo(this.$buttons);this.$selectBtn.appendTo(a);this.$selectTransformBtn=c('<div class="btn menubtn disabled">'+Craft.t("Select Transform")+"</div>").appendTo(a);for(var b=c('<div class="menu" data-align="right"></div>').insertAfter(this.$selectTransformBtn),b=c("<ul></ul>").appendTo(b),
d=0;d<Craft.AssetSelectorModal.transforms.length;d++)c('<li><a data-transform="'+Craft.AssetSelectorModal.transforms[d].handle+'">'+Craft.AssetSelectorModal.transforms[d].name+"</a></li>").appendTo(b);new Garnish.MenuBtn(this.$selectTransformBtn,{onOptionSelect:c.proxy(this,"onSelectTransform")});this.$transformSpinner=c('<div class="spinner hidden" style="margin-'+Craft.right+': -24px;"/>').insertAfter(a)}},onSelectionChange:function(a){if(this.elementSelect.totalSelected&&this.settings.canSelectImageTransforms&&
Craft.AssetSelectorModal.transforms.length){a=!0;for(var b=this.elementSelect.getSelectedItems(),d=0;d<b.length;d++)if(!c(".element.hasthumb:first",b[d]).length){a=!1;break}}else a=!1;a?this.$selectTransformBtn.removeClass("disabled"):this.$selectTransformBtn&&this.$selectTransformBtn.addClass("disabled");this.base()},onSelectTransform:function(a){a=c(a).data("transform");this.selectImagesWithTransform(a)},selectImagesWithTransform:function(a){"undefined"==typeof Craft.AssetSelectorModal.transformUrls[a]&&
(Craft.AssetSelectorModal.transformUrls[a]={});for(var b=this.elementSelect.getSelectedItems(),d=[],e=0;e<b.length;e++){var f=c(b[e]),f=Craft.getElementInfo(f).id;"undefined"==typeof Craft.AssetSelectorModal.transformUrls[a][f]&&d.push(f)}d.length?(this.$transformSpinner.removeClass("hidden"),this.fetchMissingTransformUrls(d,a,c.proxy(function(){this.$transformSpinner.addClass("hidden");this.selectImagesWithTransform(a)},this))):(this._selectedTransform=a,this.selectElements(),this._selectedTransform=
null)},fetchMissingTransformUrls:function(a,b,d){var e=a.pop();Craft.postActionRequest("assets/generateTransform",{fileId:e,handle:b,returnUrl:!0},c.proxy(function(c,g){Craft.AssetSelectorModal.transformUrls[b][e]=!1;"success"==g&&c.url&&(Craft.AssetSelectorModal.transformUrls[b][e]=c.url);a.length?this.fetchMissingTransformUrls(a,b,d):d()},this))},getElementInfo:function(a){a=this.base(a);if(this._selectedTransform)for(var b=0;b<a.length;b++){var d=a[b].id;"undefined"!=typeof Craft.AssetSelectorModal.transformUrls[this._selectedTransform][d]&&
!1!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][d]&&(a[b].url=Craft.AssetSelectorModal.transformUrls[this._selectedTransform][d])}return a},onSelect:function(a){this.settings.onSelect(a,this._selectedTransform)}},{defaults:{canSelectImageTransforms:!1},transformUrls:{}});Craft.registerElementSelectorModalClass("Asset",Craft.AssetSelectorModal);Craft.CategoryIndex=Craft.BaseElementIndex.extend({groupId:null,structure:null,$noCats:null,$addCategoryForm:null,$addCategoryInput:null,
$addCategorySpinner:null,getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultGroupHandle)for(var a=0;a<this.$sources.length;a++){var b=c(this.$sources[a]);if(b.data("handle")==defaultGroupHandle)return b.data("key")}return this.base()},onSelectSource:function(){if("index"==this.settings.context&&"undefined"!=typeof history){var a="categories/"+this.$source.data("handle");history.replaceState({},"",Craft.getUrl(a))}this.base()},getViewModesForSource:function(){return[{mode:"structure",
title:Craft.t("Display hierarchically"),icon:"structure"}]},onUpdateElements:function(a){"structure"==this.getSelectedSourceState("mode")&&(this.$noCats=this.$elements.children(".nocats"),this.$addCategoryForm=this.$elements.children("form"),this.$addCategoryInput=this.$addCategoryForm.find("input[type=text]"),this.$addCategorySpinner=this.$addCategoryForm.find(".spinner"),this.structure=this.$elementContainer.data("structure"),this.groupId=this.$addCategoryForm.data("group-id"),this.addListener(this.$addCategoryForm,
"submit","onAddCategorySubmit"));this.initElements(this.$elementContainer.find(".element"));this.base(a)},initElements:function(a){"index"==this.settings.context&&(this.addListener(a,"dblclick",function(a){Craft.showElementEditor(c(a.currentTarget))}),this.addListener(a.siblings(".delete"),"click","onDeleteClick"))},onDeleteClick:function(a){var b=c(a.currentTarget).siblings(".element"),d=Craft.getElementInfo(b);confirm(Craft.t("Are you sure you want to delete \u201c{name}\u201d and its descendants?",
{name:d.label}))&&Craft.postActionRequest("categories/deleteCategory",{categoryId:d.id},c.proxy(function(a,c){"success"==c&&(a.success?(this.structure.removeElement(b),Craft.cp.displayNotice(Craft.t("\u201c{name}\u201d deleted.",{name:d.label})),this.$elementContainer.find(".element").not(b).length||this.$noCats.removeClass("hidden")):Craft.cp.displayError(Craft.t("Couldn\u2019t delete \u201c{name}\u201d.",{name:d.label})))},this))},onAddCategorySubmit:function(a){a.preventDefault();this.$addCategorySpinner.removeClass("hidden");
a={title:this.$addCategoryInput.val(),groupId:this.groupId};Craft.postActionRequest("categories/createCategory",a,c.proxy(function(a,d){this.$addCategorySpinner.addClass("hidden");if("success"==d){this.$noCats.addClass("hidden");var e=c('<div class="element" data-editable="1"data-id="'+a.id+'" data-locale="'+Craft.locale+'" data-status="'+a.status+'" data-label="'+a.title+'" data-url="'+a.url+'"><div class="label"><span class="status '+a.status+'"></span><span class="title">'+a.title+"</span></div></div>");
this.structure.addElement(e);var f=e.parent();c('<a class="delete icon" title="'+Craft.t("Delete")+'"></a>').appendTo(f);this.initElements(e);this.$addCategoryInput.val("");f={top:24};f[Craft.left]=-5;var g={top:0};g[Craft.left]=0;e.css(f).animate(g,"fast")}},this))}});Craft.registerElementIndexClass("Category",Craft.CategoryIndex);Craft.CategorySelectInput=Craft.BaseElementSelectInput.extend({selectable:!1,sortable:!1,init:function(){this.base.apply(this,arguments);this.addLastClasses()},getElements:function(){return this.$elementsContainer.find("li:not(.hidden) > .row .element")},
initElements:function(a){this.initCheckboxes(a.siblings(".checkbox"))},initCheckboxes:function(a){this.removeListener(a,"change");this.addListener(a,"change","onCheckboxChange")},onCheckboxChange:function(a){a=c(a.currentTarget);a.prop("checked")?a.closest("li").parentsUntil(this.$elementsContainer,"li").children(".row").find(".checkbox").prop("checked",!0):a.closest("li").children("ul").find(".checkbox").prop("checked",!1)},createNewElement:function(a){var b=this.$container.find("#"+this.id+"-category-"+
a.id),d=b.parentsUntil(this.$elementsContainer,"li");a=b.add(d);var d=d.children(".row").find(".element"),c=a.children(".row").find(".checkbox"),b=b.children(".row").find(".element");a.removeClass("hidden");c.prop("checked",!0);this.initCheckboxes(c);this.$elements=this.$elements.add(d);return b},onSelectElements:function(){this.addLastClasses();this.base.apply(this,arguments)},addLastClasses:function(){for(var a=this.$elementsContainer.find("ul"),b=0;b<a.length;b++){var d=c(a[b]);d.children(".last").removeClass("last");
d.children(":not(.hidden):last").addClass("last")}}});Craft.DataTableSorter=Garnish.DragSort.extend({$table:null,init:function(a,b){this.$table=c(a);var d=this.$table.children("tbody").children(":not(.filler)");b=c.extend({},Craft.DataTableSorter.defaults,b);b.container=this.$table.children("tbody");b.helper=c.proxy(this,"getHelper");b.caboose="<tr/>";b.axis=Garnish.Y_AXIS;this.base(d,b)},getHelper:function(a){var b=c('<div class="'+this.settings.helperClass+'"/>').appendTo(Garnish.$bod),d=c("<table/>").appendTo(b),
e=c("<tbody/>").appendTo(d);a.appendTo(e);d.width(this.$table.width());d.prop("className",this.$table.prop("className"));d=this.$table.find("tr:first").children();a=a.children();for(e=0;e<a.length;e++)c(a[e]).width(c(d[e]).width());return b}},{defaults:{handle:".move",helperClass:"datatablesorthelper"}});Craft.EditableTable=Garnish.Base.extend({id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,init:function(a,b,d,e){this.id=a;this.baseName=b;this.columns=
d;this.setSettings(e,Craft.EditableTable.defaults);this.$table=c("#"+a);this.$tbody=this.$table.children("tbody");this.sorter=new Craft.DataTableSorter(this.$table,{helperClass:"editabletablesorthelper"});a=this.$tbody.children();for(b=0;b<a.length;b++)new Craft.EditableTable.Row(this,a[b]);this.$addRowBtn=this.$table.next(".add");this.addListener(this.$addRowBtn,"activate","addRow")},addRow:function(){var a=Craft.EditableTable.getRowHtml(this.settings.rowIdPrefix+(this.biggestId+1),this.columns,
this.baseName,{}),a=c(a).appendTo(this.$tbody);new Craft.EditableTable.Row(this,a);this.sorter.addItems(a);a.find("input,textarea,select").first().focus();this.settings.onAddRow(a)}},{textualColTypes:["singleline","multiline","number"],defaults:{rowIdPrefix:"",onAddRow:c.noop,onDeleteRow:c.noop},getRowHtml:function(a,b,d,c){var f='<tr data-id="'+a+'">',g;for(g in b){var h=b[g],k=d+"["+a+"]["+g+"]",m="undefined"!=typeof c[g]?c[g]:"",l=Craft.inArray(h.type,Craft.EditableTable.textualColTypes),f=f+('<td class="'+
(l?"textual":"")+" "+("undefined"!=typeof h["class"]?h["class"]:"")+'"'+("undefined"!=typeof h.width?' width="'+h.width+'"':"")+">");switch(h.type){case "select":var f=f+('<div class="select small"><select name="'+k+'">'),k=!1,n;for(n in h.options)if(l=h.options[n],"undefined"!=typeof l.optgroup)k?f+="</optgroup>":k=!0,f+='<optgroup label="'+l.optgroup+'">';else var p="undefined"!=typeof l.value?l.value:n,f=f+('<option value="'+p+'"'+(p==m?" selected":"")+("undefined"!=typeof l.disabled&&l.disabled?
" disabled":"")+">"+("undefined"!=typeof l.label?l.label:l)+"</option>");k&&(f+="</optgroup>");f+="</select></div>";break;case "checkbox":f+='<input type="hidden" name="'+k+'"><input type="checkbox" name="'+k+'" value="1"'+(m?" checked":"")+">";break;default:f+='<textarea name="'+k+'" rows="1">'+m+"</textarea>"}f+="</td>"}return f+='<td class="thin action"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin action"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>'}});
Craft.EditableTable.Row=Garnish.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,$textareas:null,$deleteBtn:null,init:function(a,b){this.table=a;this.$tr=c(b);this.$tds=this.$tr.children();var d=parseInt(this.$tr.attr("data-id").substr(this.table.settings.rowIdPrefix.length));d>this.table.biggestId&&(this.table.biggestId=d);this.$textareas=c();this.niceTexts=[];var d={},e=0,f;for(f in this.table.columns){var g=this.table.columns[f];Craft.inArray(g.type,Craft.EditableTable.textualColTypes)&&
($textarea=c("textarea",this.$tds[e]),this.$textareas=this.$textareas.add($textarea),this.addListener($textarea,"focus","onTextareaFocus"),this.addListener($textarea,"mousedown","ignoreNextTextareaFocus"),this.niceTexts.push(new Garnish.NiceText($textarea,{onHeightChange:c.proxy(this,"onTextareaHeightChange")})),"singleline"!=g.type&&"number"!=g.type||this.addListener($textarea,"keypress",{type:g.type},"validateKeypress"),d[f]=$textarea);e++}this.onTextareaHeightChange();for(f in this.table.columns)g=
this.table.columns[f],g.autopopulate&&"undefined"!=typeof d[g.autopopulate]&&!d[f].val()&&("handle"==g.autopopulate?new Craft.HandleGenerator(d[f],d[g.autopopulate]):new Craft.BaseInputGenerator(d[f],d[g.autopopulate]));f=this.$tr.children().last().find(".delete");this.addListener(f,"click","deleteRow")},onTextareaFocus:function(a){var b=c(a.currentTarget);b.data("ignoreNextFocus")?b.data("ignoreNextFocus",!1):setTimeout(function(){var a=b.val();"undefined"!=typeof b[0].setSelectionRange?b[0].setSelectionRange(0,
2*a.length):b.val(a)},0)},ignoreNextTextareaFocus:function(a){c.data(a.currentTarget,"ignoreNextFocus",!0)},validateKeypress:function(a){var b=a.keyCode?a.keyCode:a.charCode;a.metaKey||a.ctrlKey||b!=Garnish.RETURN_KEY&&("number"!=a.data.type||Craft.inArray(b,Craft.EditableTable.Row.numericKeyCodes))||a.preventDefault()},onTextareaHeightChange:function(){for(var a=-1,b=0;b<this.niceTexts.length;b++)this.niceTexts[b].height>a&&(a=this.niceTexts[b].height);this.$textareas.css("min-height",a)},deleteRow:function(){this.table.sorter.removeItems(this.$tr);
this.$tr.remove();this.table.settings.onDeleteRow(this.$tr)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,55,56,57]});Craft.ElementEditor=Garnish.Base.extend({$element:null,elementId:null,locale:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,$localeSelect:null,$localeSpinner:null,hud:null,init:function(a){this.$element=a;this.elementId=a.data("id");this.$element.addClass("loading");a={elementId:this.elementId,locale:this.$element.data("locale"),
includeLocales:!0};Craft.postActionRequest("elements/getEditorHtml",a,c.proxy(this,"showHud"))},showHud:function(a,b){this.$element.removeClass("loading");if("success"==b){var d=c();if(a.locales){var e=c('<div class="header"/>'),f=c('<div class="select"/>').appendTo(e);this.$localeSelect=c("<select/>").appendTo(f);this.$localeSpinner=c('<div class="spinner hidden"/>').appendTo(e);for(f=0;f<a.locales.length;f++){var g=a.locales[f];c('<option value="'+g.id+'"'+(g.id==a.locale?' selected="selected"':
"")+">"+g.name+"</option>").appendTo(this.$localeSelect)}this.addListener(this.$localeSelect,"change","switchLocale");d=d.add(e)}this.$form=c("<form/>");this.$fieldsContainer=c('<div class="fields"/>').appendTo(this.$form);this.updateForm(a);e=c('<div class="footer"/>').appendTo(this.$form);this.$spinner=c('<div class="spinner hidden"/>').appendTo(e);e=c('<div class="buttons right"/>').appendTo(e);this.$cancelBtn=c('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(e);this.$saveBtn=c('<input class="btn submit" type="submit" value="'+
Craft.t("Save")+'"/>').appendTo(e);d=d.add(this.$form);this.hud=new Garnish.HUD(this.$element,d,{bodyClass:"body elementeditor",closeOtherHUDs:!1});this.hud.on("hide",c.proxy(function(){delete this.hud},this));this.addListener(this.$form,"submit","saveElement");this.addListener(this.$cancelBtn,"click",function(){this.hud.hide()})}},switchLocale:function(){var a=this.$localeSelect.val();a!=this.locale&&(this.$localeSpinner.removeClass("hidden"),Craft.postActionRequest("elements/getEditorHtml",{elementId:this.elementId,
locale:a},c.proxy(function(a,c){this.$localeSpinner.addClass("hidden");"success"==c?this.updateForm(a):this.$localeSelect.val(this.locale)},this)))},updateForm:function(a){this.locale=a.locale;this.$fieldsContainer.html(a.html);Craft.initUiElements(this.$fieldsContainer)},saveElement:function(a){a.preventDefault();this.$spinner.removeClass("hidden");a=this.$form.serialize();Craft.postActionRequest("elements/saveElement",a,c.proxy(function(a,c){this.$spinner.addClass("hidden");"success"==c&&("success"==
c&&a.success?(this.locale==this.$element.data("locale")&&this.$element.find(".title").text(a.newTitle),"undefined"!=typeof Craft.livePreview&&Craft.livePreview.updateIframe(!0),this.closeHud()):(this.updateForm(a),Garnish.shake(this.hud.$hud)))},this))},closeHud:function(){this.hud.hide();delete this.hud}});Craft.EntryIndex=Craft.BaseElementIndex.extend({getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultSectionHandle){if("singles"==defaultSectionHandle)return"singles";
for(var a=0;a<this.$sources.length;a++){var b=c(this.$sources[a]);if(b.data("handle")==defaultSectionHandle)return b.data("key")}}return this.base()},onSelectSource:function(){if("index"==this.settings.context&&"undefined"!=typeof history){var a="singles"==this.$source.data("key")?"singles":this.$source.data("handle"),b="entries";a&&(b+="/"+a);history.replaceState({},"",Craft.getUrl(b))}this.base()}});Craft.registerElementIndexClass("Entry",Craft.EntryIndex);Craft.EntryUrlFormatGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(a){a=
a.replace("/<(.*?)>/g","");a=a.toLowerCase();a=Craft.asciiString(a);a=a.replace(/^[^a-z]+/,"");a=a.replace(/[^a-z0-9]+$/,"");(a=Craft.filterArray(a.split(/[^a-z0-9]+/)).join("-"))&&this.settings.suffix&&(a+=this.settings.suffix);return a}});Craft.FieldLayoutDesigner=Garnish.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(a,b){this.$container=c(a);this.setSettings(b,
Craft.FieldLayoutDesigner.defaults);this.$tabContainer=this.$container.children(".fld-tabs");this.$unusedFieldContainer=this.$container.children(".unusedfields");this.$newTabBtn=c("#newtabbtn");this.$allFields=this.$unusedFieldContainer.find(".fld-field");this.tabGrid=new Craft.Grid(this.$tabContainer,Craft.FieldLayoutDesigner.gridSettings);this.unusedFieldGrid=new Craft.Grid(this.$unusedFieldContainer,Craft.FieldLayoutDesigner.gridSettings);for(var d=this.$tabContainer.children(),e=0;e<d.length;e++)this.initTab(c(d[e]));
this.fieldDrag=new Craft.FieldLayoutDesigner.FieldDrag(this);this.settings.customizableTabs&&(this.tabDrag=new Craft.FieldLayoutDesigner.TabDrag(this),this.addListener(this.$newTabBtn,"activate","addTab"))},initTab:function(a){if(this.settings.customizableTabs){var b=a.find(".tabs .settings"),d=c('<div class="menu" data-align="center"/>').insertAfter(b),d=c("<ul/>").appendTo(d);c('<li><a data-action="rename">'+Craft.t("Rename")+"</a></li>").appendTo(d);c('<li><a data-action="delete">'+Craft.t("Delete")+
"</a></li>").appendTo(d);new Garnish.MenuBtn(b,{onOptionSelect:c.proxy(this,"onTabOptionSelect")})}a=a.children(".fld-tabcontent").children();for(b=0;b<a.length;b++)this.initField(c(a[b]))},initField:function(a){var b=a.find(".settings"),d=c('<div class="menu" data-align="center"/>').insertAfter(b),d=c("<ul/>").appendTo(d);a.hasClass("fld-required")?c('<li><a data-action="toggle-required">'+Craft.t("Make not required")+"</a></li>").appendTo(d):c('<li><a data-action="toggle-required">'+Craft.t("Make required")+
"</a></li>").appendTo(d);c('<li><a data-action="remove">'+Craft.t("Remove")+"</a></li>").appendTo(d);new Garnish.MenuBtn(b,{onOptionSelect:c.proxy(this,"onFieldOptionSelect")})},onTabOptionSelect:function(a){if(this.settings.customizableTabs){a=c(a);var b=a.data("menu").$trigger.parent().parent().parent();switch(a.data("action")){case "rename":this.renameTab(b);break;case "delete":this.deleteTab(b)}}},onFieldOptionSelect:function(a){a=c(a);var b=a.data("menu").$trigger.parent();switch(a.data("action")){case "toggle-required":this.toggleRequiredField(b,
a);break;case "remove":this.removeField(b)}},renameTab:function(a){if(this.settings.customizableTabs){var b=a.find(".tabs .tab span"),c=b.text(),e=prompt(Craft.t("Give your tab a name."),c);e&&e!=c&&(b.text(e),a.find(".id-input").attr("name","fieldLayout["+Craft.encodeUriComponent(e)+"][]"))}},deleteTab:function(a){if(this.settings.customizableTabs){for(var b=a.find(".fld-field"),d=0;d<b.length;d++){var e=c(b[d]).attr("data-id");this.removeFieldById(e)}this.tabGrid.removeItems(a);this.tabDrag.removeItems(a);
a.remove()}},toggleRequiredField:function(a,b){a.hasClass("fld-required")?(a.removeClass("fld-required"),a.find(".required-input").remove(),setTimeout(function(){b.text(Craft.t("Make required"))},500)):(a.addClass("fld-required"),c('<input class="required-input" type="hidden" name="requiredFields[]" value="'+a.data("id")+'">').appendTo(a),setTimeout(function(){b.text(Craft.t("Make not required"))},500))},removeField:function(a){var b=a.attr("data-id");a.remove();this.removeFieldById(b);this.tabGrid.refreshCols()},
removeFieldById:function(a){a=this.$allFields.filter("[data-id="+a+"]:first");var b=a.closest(".fld-tab");a.removeClass("hidden");b.hasClass("hidden")?(b.removeClass("hidden"),this.unusedFieldGrid.addItems(b),this.settings.customizableTabs&&this.tabDrag.addItems(b)):this.unusedFieldGrid.refreshCols()},addTab:function(){if(this.settings.customizableTabs){var a=c('<div class="fld-tab"><div class="tabs"><div class="tab sel draggable"><span>Tab '+(this.tabGrid.$items.length+1)+'</span><a class="settings icon" title="'+
Craft.t("Rename")+'"></a></div></div><div class="fld-tabcontent"></div></div>').appendTo(this.$tabContainer);this.tabGrid.addItems(a);this.tabDrag.addItems(a);this.initTab(a)}}},{gridSettings:{itemSelector:".fld-tab:not(.hidden)",minColWidth:240,percentageWidths:!1,fillMode:"grid",snapToGrid:30},defaults:{customizableTabs:!0}});Craft.FieldLayoutDesigner.BaseDrag=Garnish.Drag.extend({designer:null,$insertion:null,showingInsertion:!1,$caboose:null,draggingUnusedItem:!1,addToTabGrid:!1,init:function(a,
b){this.designer=a;var c=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));this.base(c,b)},onDragStart:function(){this.base();this.draggingUnusedItem=this.$draggee.hasClass("unused");this.$insertion=this.getInsertion();this.addCaboose();this.$items=c().add(this.$items.add(this.$caboose));this.addToTabGrid&&this.designer.tabGrid.addItems(this.$caboose);this.draggingUnusedItem?this.showingInsertion=!1:(this.$insertion.insertBefore(this.$draggee),
this.$draggee.detach(),this.$items=c().add(this.$items.not(this.$draggee).add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$draggee),this.designer.tabGrid.addItems(this.$insertion)));this.setMidpoints()},addCaboose:c.noop,getItemContainer:c.noop,isItemInTabContainer:function(a){return this.getItemContainer(a)[0]==this.designer.$tabContainer[0]},setMidpoints:function(){for(var a=0;a<this.$items.length;a++){var b=c(this.$items[a]);if(this.isItemInTabContainer(b)){var d=
b.offset();b.data("midpoint",{left:d.left+b.outerWidth()/2,top:d.top+b.outerHeight()/2})}}},onDrag:function(){this.draggingUnusedItem&&!Garnish.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)?this.showingInsertion&&(this.$insertion.remove(),this.$items=c().add(this.$items.not(this.$insertion)),this.showingInsertion=!1,this.addToTabGrid?this.designer.tabGrid.removeItems(this.$insertion):this.designer.tabGrid.refreshCols(),this.setMidpoints()):(this.onDrag._closestItem=this.getClosestItem(),
this.onDrag._closestItem!=this.$insertion[0]&&(this.showingInsertion&&c.inArray(this.$insertion[0],this.$items)<c.inArray(this.onDrag._closestItem,this.$items)&&-1==c.inArray(this.onDrag._closestItem,this.$caboose)?this.$insertion.insertAfter(this.onDrag._closestItem):this.$insertion.insertBefore(this.onDrag._closestItem),this.$items=c().add(this.$items.add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid?this.designer.tabGrid.addItems(this.$insertion):this.designer.tabGrid.refreshCols(),
this.setMidpoints()));this.base()},getClosestItem:function(){this.getClosestItem._closestItem=null;this.getClosestItem._closestItemMouseDiff=null;for(this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++)if(this.getClosestItem._$item=c(this.$items[this.getClosestItem._i]),this.isItemInTabContainer(this.getClosestItem._$item)&&(this.getClosestItem._midpoint=this.getClosestItem._$item.data("midpoint"),this.getClosestItem._mouseDiff=Garnish.getDist(this.getClosestItem._midpoint.left,
this.getClosestItem._midpoint.top,this.mouseX,this.mouseY),null===this.getClosestItem._closestItem||this.getClosestItem._mouseDiff<this.getClosestItem._closestItemMouseDiff))this.getClosestItem._closestItem=this.getClosestItem._$item[0],this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff;return this.getClosestItem._closestItem},onDragStop:function(){this.showingInsertion&&(this.$insertion.replaceWith(this.$draggee),this.$items=c().add(this.$items.not(this.$insertion).add(this.$draggee)),
this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$insertion),this.designer.tabGrid.addItems(this.$draggee)));this.$items=this.$items.not(this.$caboose);this.$caboose.remove();this.addToTabGrid&&this.designer.tabGrid.removeItems(this.$caboose);this.$draggee.css({display:this.draggeeDisplay,visibility:"hidden"});this.designer.tabGrid.refreshCols();this.designer.unusedFieldGrid.refreshCols();this.returnHelpersToDraggees();this.base()}});Craft.FieldLayoutDesigner.TabDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab",
addToTabGrid:!0,init:function(a){this.base(a,{handle:".tab"})},addCaboose:function(){this.$caboose=c('<div class="fld-tab fld-tab-caboose"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var a=this.$draggee.find(".tab");return c('<div class="fld-tab fld-insertion" style="height: '+this.$draggee.height()+'px;"><div class="tabs"><div class="tab sel draggable" style="width: '+a.width()+"px; height: "+a.height()+'px;"></div></div><div class="fld-tabcontent" style="height: '+this.$draggee.find(".fld-tabcontent").height()+
'px;"></div></div>')},getItemContainer:function(a){return a.parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var a=this.$draggee.clone().removeClass("unused"),b=a.find(".tab span").text();a.find(".fld-field").removeClass("unused");a.find(".tabs .tab").append('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');var d=a.find(".fld-field"),e=d.filter(".hidden").remove(),d=d.not(e);d.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');for(e=0;e<
d.length;e++){var f=c(d[e]);f.append('<input class="id-input" type="hidden" name="fieldLayout['+Craft.encodeUriComponent(b)+'][]" value="'+f.data("id")+'">')}this.designer.fieldDrag.addItems(d);this.designer.initTab(a);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");this.$draggee.find(".fld-field").addClass("hidden");this.$draggee=a;this.addItems(a);this.designer.tabGrid.addItems(a);this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}});Craft.FieldLayoutDesigner.FieldDrag=
Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab .fld-field",addCaboose:function(){this.$caboose=c();for(var a=this.designer.$tabContainer.children().children(".fld-tabcontent"),b=0;b<a.length;b++){var d=c('<div class="fld-tab fld-tab-caboose"/>').appendTo(a[b]);this.$caboose=this.$caboose.add(d)}},getInsertion:function(){return c('<div class="fld-field fld-insertion" style="height: '+this.$draggee.height()+'px;"/>')},getItemContainer:function(a){return a.parent().parent().parent()},
onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var a=this.$draggee.clone().removeClass("unused");a.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');this.designer.initField(a);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");if(0==this.$draggee.siblings(":not(.hidden)").length){var b=this.$draggee.parent().parent();b.addClass("hidden");this.designer.unusedFieldGrid.removeItems(b)}this.$draggee=a;this.addItems(a)}this.showingInsertion&&
(a=this.$insertion.parent().parent().find(".tab span").text(),a="fieldLayout["+Craft.encodeUriComponent(a)+"][]",this.draggingUnusedItem?this.$draggee.append('<input class="id-input" type="hidden" name="'+a+'" value="'+this.$draggee.data("id")+'">'):this.$draggee.find(".id-input").attr("name",a));this.base()}});Craft.FieldToggle=Garnish.Base.extend({$toggle:null,targetPrefix:null,targetSelector:null,reverseTargetSelector:null,_$target:null,_$reverseTarget:null,type:null,init:function(a){this.$toggle=
c(a);this.$toggle.data("fieldtoggle")&&(Garnish.log("Double-instantiating a field toggle on an element"),this.$toggle.data("fieldtoggle").destroy());this.$toggle.data("fieldtoggle",this);this.type=this.getType();"select"==this.type?this.targetPrefix=this.$toggle.attr("data-target-prefix")||"":(this.targetSelector=this.normalizeTargetSelector(this.$toggle.data("target")),this.reverseTargetSelector=this.normalizeTargetSelector(this.$toggle.data("reverse-target")));this.findTargets();"link"==this.type?
this.addListener(this.$toggle,"click","onToggleChange"):this.addListener(this.$toggle,"change","onToggleChange")},normalizeTargetSelector:function(a){a&&!a.match(/^[#\.]/)&&(a="#"+a);return a},getType:function(){if("INPUT"==this.$toggle.prop("nodeName")&&"checkbox"==this.$toggle.attr("type").toLowerCase())return"checkbox";if("SELECT"==this.$toggle.prop("nodeName"))return"select";if("A"==this.$toggle.prop("nodeName"))return"link"},findTargets:function(){"select"==this.type?this._$target=c(this.normalizeTargetSelector(this.targetPrefix+
this.getToggleVal())):(this.targetSelector&&(this._$target=c(this.targetSelector)),this.reverseTargetSelector&&(this._$reverseTarget=c(this.reverseTargetSelector)))},getToggleVal:function(){return Garnish.getInputPostVal(this.$toggle)},onToggleChange:function(){"select"==this.type?(this.hideTarget(this._$target),this.findTargets(),this.showTarget(this._$target)):("link"==this.type?this.$toggle.hasClass("collapsed")||!this.$toggle.hasClass("expanded"):this.getToggleVal())?(this.showTarget(this._$target),
this.hideTarget(this._$reverseTarget)):(this.hideTarget(this._$target),this.showTarget(this._$reverseTarget))},showTarget:function(a){if(a&&a.length&&(a.removeClass("hidden"),"select"!=this.type)){"link"==this.type&&(this.$toggle.removeClass("collapsed"),this.$toggle.addClass("expanded"));a.height("auto");var b=a.height();a.height(0);a.stop().animate({height:b},"fast",function(){a.height("auto")})}},hideTarget:function(a){a&&a.length&&("select"==this.type?a.addClass("hidden"):("link"==this.type&&
(this.$toggle.removeClass("expanded"),this.$toggle.addClass("collapsed")),a.stop().animate({height:0},"fast",function(){a.addClass("hidden")})))}});Craft.Grid=Garnish.Base.extend({$container:null,$items:null,items:null,totalCols:null,colPctWidth:null,sizeUnit:null,possibleItemColspans:null,possibleItemPositionsByColspan:null,itemPositions:null,itemColspansByPosition:null,layouts:null,layout:null,itemHeights:null,leftPadding:null,init:function(a,b){this.$container=c(a);this.setSettings(b,Craft.Grid.defaults);
this.sizeUnit="pct"==this.settings.mode?"%":"px";this.$items=this.$container.children(this.settings.itemSelector);this.setItems();this.refreshCols();this.addListener(this.$container,"resize","refreshCols");Garnish.$win.trigger("resize")},addItems:function(a){this.$items=c().add(this.$items.add(a));this.setItems();this.refreshCols()},removeItems:function(a){this.$items=c().add(this.$items.not(a));this.setItems();this.refreshCols()},setItems:function(){this.items=[];for(var a=0;a<this.$items.length;a++)this.items.push(c(this.$items[a]))},
refreshCols:function(){if(this.items.length)if(this.totalCols=this.settings.cols?this.settings.cols:Math.floor(this.$container.width()/this.settings.minColWidth),0==this.totalCols&&(this.totalCols=1),"grid"==this.settings.fillMode)for(var a=0;a<this.items.length;){for(var b=-1,d=0,e=a;e<a+this.totalCols&&e<this.items.length;e++){var f=this.items[e].height("auto").height();f>b&&(b=f);d++}this.settings.snapToGrid&&(e=b%this.settings.snapToGrid)&&(b+=this.settings.snapToGrid-e);for(e=a;e<a+this.totalCols&&
e<this.items.length;e++)this.items[e].height(b);a+=this.totalCols}else{this.removeListener(this.$items,"resize");"pct"==this.settings.mode&&(this.colPctWidth=100/this.totalCols);this.layouts=[];this.itemPositions=[];this.itemColspansByPosition=[];this.possibleItemColspans=[];this.possibleItemPositionsByColspan=[];this.itemHeightsByColspan=[];for(e=0;e<this.items.length;e++){this.possibleItemColspans[e]=[];this.possibleItemPositionsByColspan[e]={};this.itemHeightsByColspan[e]={};var a=this.items[e].show(),
b="right"==a.data("position"),d="left"==a.data("position"),g=a.data("colspan")?a.data("colspan"):a.data("min-colspan")?a.data("min-colspan"):1,f=a.data("colspan")?a.data("colspan"):a.data("max-colspan")?a.data("max-colspan"):this.totalCols;g>this.totalCols&&(g=this.totalCols);f>this.totalCols&&(f=this.totalCols);for(;g<=f;g++){a.css("width",this.getItemWidth(g)+this.sizeUnit);this.itemHeightsByColspan[e][g]=a.outerHeight();this.possibleItemColspans[e].push(g);this.possibleItemPositionsByColspan[e][g]=
[];if(d)var h=0,k=0;else b?k=h=this.totalCols-g:(h=0,k=this.totalCols-g);for(;h<=k;h++)this.possibleItemPositionsByColspan[e][g].push(h)}}a=[];for(e=0;e<this.totalCols;e++)a.push(0);this.createLayouts(0,[],[],a,0);a=[];for(e=0;e<this.layouts.length;e++)a.push(Math.max.apply(null,this.layouts[e].colHeights));b=Math.min.apply(null,a);d=[];f=[];for(e=0;e<a.length;e++)if(a[e]==b){d.push(this.layouts[e]);g=this.layouts[e].emptySpace;for(k=0;k<this.totalCols;k++)g+=b-this.layouts[e].colHeights[k];f.push(g)}this.layout=
d[c.inArray(Math.min.apply(null,f),f)];a=0;for(e=this.layout.colHeights.length-1;0<=e;e--)if(0==this.layout.colHeights[e])a++;else break;this.leftPadding=this.getItemWidth(a)/2;"fixed"==this.settings.mode&&(this.leftPadding+=(this.$container.width()-this.settings.minColWidth*this.totalCols)/2);this.positionItems();this.addListener(this.$items,"resize","onItemResize")}},getItemWidth:function(a){return"pct"==this.settings.mode?this.colPctWidth*a:this.settings.minColWidth*a},createLayouts:function(a,
b,d,e,f){for(var g=0;g<this.possibleItemColspans[a].length;g++){for(var h=this.possibleItemColspans[a][g],k=[],m=0;m<this.possibleItemPositionsByColspan[a][h].length;m++){for(var l=this.possibleItemPositionsByColspan[a][h][m],n=[],p=l+h-1;l<=p;l++)n.push(e[l]);k[m]=Math.max.apply(null,n)}var m=c.inArray(Math.min.apply(null,k),k),l=this.possibleItemPositionsByColspan[a][h][m],n=b.slice(0),q=d.slice(0),r=e.slice(0),s=f;n.push(l);q.push(h);k=k[m];for(p=l+h-1;l<=p;l++)s+=k-r[l],r[l]=k+this.itemHeightsByColspan[a][h];
a==this.items.length-1?this.layouts.push({positions:n,colspans:q,colHeights:r,emptySpace:s}):this.createLayouts(a+1,n,q,r,s)}},positionItems:function(){for(var a=[],b=0;b<this.totalCols;b++)a.push(0);for(b=0;b<this.items.length;b++){for(var c=this.layout.positions[b]+this.layout.colspans[b]-1,e=[],f=this.layout.positions[b];f<=c;f++)e.push(a[f]);e=Math.max.apply(null,e);f={top:e,width:this.getItemWidth(this.layout.colspans[b])+this.sizeUnit};f[Craft.left]=this.leftPadding+this.getItemWidth(this.layout.positions[b])+
this.sizeUnit;this.items[b].css(f);for(f=this.layout.positions[b];f<=c;f++)a[f]=e+this.itemHeightsByColspan[b][this.layout.colspans[b]]}this.$container.css({height:Math.max.apply(null,a)})},onItemResize:function(a){a.stopPropagation();a=c.inArray(a.currentTarget,this.$items);if(-1!=a){var b=this.items[a].outerHeight();b!=this.itemHeightsByColspan[a][this.layout.colspans[a]]&&(this.itemHeightsByColspan[a][this.layout.colspans[a]]=b,this.positionItems())}}},{defaults:{itemSelector:".item",cols:null,
minColWidth:320,mode:"pct",fillMode:"top",colClass:"col",snapToGrid:null}});Craft.HandleGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(a){a=a.replace("/<(.*?)>/g","");a=a.replace(/['"\u2018\u2019\u201c\u201d\[\]\(\)\{\}:]/g,"");a=a.toLowerCase();a=Craft.asciiString(a);a=a.replace(/^[^a-z]+/,"");var b=Craft.filterArray(a.split(/[^a-z0-9]+/));a="";for(var c=0;c<b.length;c++)a=0==c?a+b[c]:a+(b[c].charAt(0).toUpperCase()+b[c].substr(1));return a}});Craft.ImageUpload=Garnish.Base.extend({_imageHandler:null,
init:function(a){this.setSettings(a,Craft.ImageUpload.defaults);this._imageHandler=new Craft.ImageHandler(a)}},{$modalContainerDiv:null,defaults:{postParameters:{},modalClass:"",uploadButton:{},uploadAction:"",deleteButton:{},deleteMessage:"",deleteAction:"",cropAction:"",areaToolOptions:{aspectRatio:"1:1",initialRectangle:{mode:"auto",x1:0,x2:0,y1:0,y2:0}},onImageDelete:function(a){location.reload()},onImageSave:function(a){location.reload()}}});Craft.ImageHandler=Garnish.Base.extend({modal:null,
progressBar:null,$container:null,init:function(a){this.setSettings(a);var b=this,d=a.uploadButton,e=c('<input type="file" name="image-upload" id="image-upload" />').hide().insertBefore(d);this.progressBar=new Craft.ProgressBar(c('<div class="progress-shade"></div>').insertBefore(d));this.progressBar.$progressBar.css({top:Math.round(d.outerHeight()/2)-6});this.$container=d.parent();e={url:Craft.getActionUrl(this.settings.uploadAction),fileInput:e,element:this.settings.uploadButton[0],action:Craft.actionUrl+
"/"+this.settings.uploadAction,formData:this.settings.postParameters,events:{fileuploadstart:c.proxy(function(){this.$container.addClass("uploading");this.progressBar.resetProgressBar();this.progressBar.showProgressBar()},this),fileuploadprogressall:c.proxy(function(a){a=parseInt(100*(a.loaded/a.total),10);this.progressBar.setProgressPercentage(a)},this),fileuploaddone:c.proxy(function(d,e){this.progressBar.hideProgressBar();this.$container.removeClass("uploading");var h=e.result;null==Craft.ImageUpload.$modalContainerDiv&&
(Craft.ImageUpload.$modalContainerDiv=c('<div class="modal fitted"></div>').addClass(a.modalClass).appendTo(Garnish.$bod));h.html&&(Craft.ImageUpload.$modalContainerDiv.empty().append(h.html),this.modal?this.modal.show():(this.modal=new Craft.ImageModal(Craft.ImageUpload.$modalContainerDiv,{postParameters:a.postParameters,cropAction:a.cropAction}),this.modal.imageHandler=b),this.modal.bindButtons(),this.modal.addListener(this.modal.$saveBtn,"click","saveImage"),this.modal.addListener(this.modal.$cancelBtn,
"click","cancel"),this.modal.removeListener(Garnish.Modal.$shade,"click"),setTimeout(c.proxy(function(){Craft.ImageUpload.$modalContainerDiv.find("img").load(c.proxy(function(){var b=new Craft.ImageAreaTool(a.areaToolOptions);b.showArea(this.modal);this.modal.cropAreaTool=b},this))},this),1))},this)},acceptFileTypes:/(jpg|jpeg|gif|png)/};this.uploader=new Craft.Uploader(d,e);c(a.deleteButton).click(function(){confirm(a.deleteMessage)&&(c(this).parent().append('<div class="blocking-modal"></div>'),
Craft.postActionRequest(a.deleteAction,a.postParameters,c.proxy(function(a,c){"success"==c&&b.onImageDelete.apply(b,[a])},this)))});c(a.uploadButton).on("click",function(a){c(this).siblings("input[type=file]").click()})},onImageSave:function(a){this.settings.onImageSave.apply(this,[a])},onImageDelete:function(a){this.settings.onImageDelete.apply(this,[a])}});Craft.ImageModal=Garnish.Modal.extend({$container:null,$saveBtn:null,$cancelBtn:null,areaSelect:null,factor:null,source:null,_postParameters:null,
_cropAction:"",imageHandler:null,originalWidth:0,originalHeight:0,constraint:0,cropAreaTool:null,init:function(a,b){this.cropAreaTool=null;this.base(a,b);this._postParameters=b.postParameters;this._cropAction=b.cropAction;this.addListener(this.$container,"resize",c.proxy(this,"_onResize"));this.addListener(Garnish.$bod,"resize",c.proxy(this,"_onResize"))},_onResize:function(){var a=this.$container.find("img"),b=parseInt(this.$container.css("left"),10),c=parseInt(this.$container.css("top"),10),e=this.originalWidth/
this.originalHeight,b=b-10,c=c-10,c=b/e>c?this.$container.width()+c*e:this.$container.width()+b,c=Math.min(c,this.constraint,this.constraint*e,this.originalWidth);this.$container.width(c);c=this.$container.width();e=c/this.originalWidth;a.height(this.originalHeight*e).width(c);this.factor=e;this.cropAreaTool&&a.imgAreaSelect({instance:!0}).update()},bindButtons:function(){this.$saveBtn=this.$container.find(".submit:first");this.$cancelBtn=this.$container.find(".cancel:first")},cancel:function(){this.hide();
this.areaSelect.setOptions({remove:!0,hide:!0,disable:!0});this.$container.empty()},saveImage:function(){var a=this.areaSelect.getSelection(),a={x1:Math.round(a.x1/this.factor),x2:Math.round(a.x2/this.factor),y1:Math.round(a.y1/this.factor),y2:Math.round(a.y2/this.factor),source:this.source},a=c.extend(this._postParameters,a);Craft.postActionRequest(this._cropAction,a,c.proxy(function(a,c){"success"==c&&(a.error?Craft.cp.displayError(a.error):this.imageHandler.onImageSave.apply(this.imageHandler,
[a]));this.hide();this.$container.empty();this.areaSelect.setOptions({remove:!0,hide:!0,disable:!0})},this));this.areaSelect.setOptions({disable:!0});this.removeListener(this.$saveBtn,"click");this.removeListener(this.$cancelBtn,"click");this.$container.find(".crop-image").fadeTo(50,0.5)}});Craft.ImageAreaTool=Garnish.Base.extend({$container:null,init:function(a){this.$container=Craft.ImageUpload.$modalContainerDiv;this.setSettings(a)},showArea:function(a){var b=this.$container.find("img"),c={aspectRatio:this.settings.aspectRatio,
maxWidth:b.width(),maxHeight:b.height(),instance:!0,resizable:!0,show:!0,persistent:!0,handles:!0,parent:b.parent(),classPrefix:"imgareaselect"},c=b.imgAreaSelect(c),e=this.settings.initialRectangle.x1,f=this.settings.initialRectangle.x2,g=this.settings.initialRectangle.y1,h=this.settings.initialRectangle.y2;"auto"==this.settings.initialRectangle.mode&&(e=this.settings.aspectRatio.split(":"),h=f=0,e[0]>e[1]?(f=b.width(),h=f*e[1]/e[0]):e[0]>e[1]?(h=b.height(),f=h*e[0]/e[1]):h=f=Math.min(b.width(),
b.height()),e=Math.round((b.width()-f)/2),g=Math.round((b.height()-h)/2),f=e+f,h=g+h);c.setSelection(e,g,f,h);c.update();a.areaSelect=c;a.factor=b.data("factor");a.originalHeight=b.attr("height")/a.factor;a.originalWidth=b.attr("width")/a.factor;a.constraint=b.data("constraint");a.source=b.attr("src").split("/").pop();a.updateSizeAndPosition()}});Craft.InfoIcon=Garnish.Base.extend({$icon:null,hud:null,init:function(a){this.$icon=c(a);this.addListener(this.$icon,"click","showHud")},showHud:function(){this.hud?
this.hud.show():this.hud=new Garnish.HUD(this.$icon,this.$icon.html(),{hudClass:"hud info-hud"})}});Craft.LightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,$toggleTarget:null,on:null,dragger:null,dragStartMargin:null,init:function(a,b){this.$outerContainer=c(a);this.$outerContainer.data("lightswitch")&&(Garnish.log("Double-instantiating a lightswitch on an element"),this.$outerContainer.data("lightswitch").destroy());this.$outerContainer.data("lightswitch",
this);this.setSettings(b,Craft.LightSwitch.defaults);this.$innerContainer=this.$outerContainer.find(".lightswitch-container:first");this.$input=this.$outerContainer.find("input:first");this.$toggleTarget=c(this.$outerContainer.attr("data-toggle"));this.on=this.$outerContainer.hasClass("on");this.addListener(this.$outerContainer,"mousedown","_onMouseDown");this.addListener(this.$outerContainer,"keydown","_onKeyDown");this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreHandleSelector:null,
onDragStart:c.proxy(this,"_onDragStart"),onDrag:c.proxy(this,"_onDrag"),onDragStop:c.proxy(this,"_onDragStop")})},turnOn:function(){this.$outerContainer.addClass("dragging");var a={};a["margin-"+Craft.left]=0;this.$innerContainer.stop().animate(a,Craft.LightSwitch.animationDuration,c.proxy(this,"_onSettle"));this.$input.val("1");this.$outerContainer.addClass("on");this.on=!0;this.settings.onChange();this.$toggleTarget.show();this.$toggleTarget.height("auto");a=this.$toggleTarget.height();this.$toggleTarget.height(0);
this.$toggleTarget.stop().animate({height:a},Craft.LightSwitch.animationDuration,c.proxy(function(){this.$toggleTarget.height("auto")},this))},turnOff:function(){this.$outerContainer.addClass("dragging");var a={};a["margin-"+Craft.left]=Craft.LightSwitch.offMargin;this.$innerContainer.stop().animate(a,Craft.LightSwitch.animationDuration,c.proxy(this,"_onSettle"));this.$input.val("");this.$outerContainer.removeClass("on");this.on=!1;this.settings.onChange();this.$toggleTarget.stop().animate({height:0},
Craft.LightSwitch.animationDuration)},toggle:function(a){this.on?this.turnOff():this.turnOn()},_onMouseDown:function(){this.addListener(Garnish.$doc,"mouseup","_onMouseUp")},_onMouseUp:function(){this.removeListener(Garnish.$doc,"mouseup");this.dragger.dragging||this.toggle()},_onKeyDown:function(a){switch(a.keyCode){case Garnish.SPACE_KEY:this.toggle();a.preventDefault();break;case Garnish.RIGHT_KEY:"ltr"==Craft.orientation?this.turnOn():this.turnOff();a.preventDefault();break;case Garnish.LEFT_KEY:"ltr"==
Craft.orientation?this.turnOff():this.turnOn(),a.preventDefault()}},_getMargin:function(){return parseInt(this.$innerContainer.css("margin-"+Craft.left))},_onDragStart:function(){this.$outerContainer.addClass("dragging");this.dragStartMargin=this._getMargin()},_onDrag:function(){var a="ltr"==Craft.orientation?this.dragStartMargin+this.dragger.mouseDistX:this.dragStartMargin-this.dragger.mouseDistX;a<Craft.LightSwitch.offMargin?a=Craft.LightSwitch.offMargin:0<a&&(a=0);this.$innerContainer.css("margin-"+
Craft.left,a)},_onDragStop:function(){this._getMargin()>Craft.LightSwitch.offMargin/2?this.turnOn():this.turnOff()},_onSettle:function(){this.$outerContainer.removeClass("dragging")},destroy:function(){this.base();this.dragger.destroy()}},{offMargin:-9,animationDuration:100,defaults:{onChange:c.noop}});Craft.Pane=Garnish.Base.extend({$pane:null,$content:null,$sidebar:null,$sidebarBtn:null,tabs:null,selectedTab:null,hasSidebar:null,showingSidebar:null,peekingSidebar:null,fixedSidebar:null,init:function(a){this.$pane=
c(a);this.$pane.data("pane")&&(Garnish.log("Double-instantiating a pane on an element"),this.$pane.data("pane").destroy());this.$pane.data("pane",this);this.$content=this.$pane.find(".content:not(.hidden):first");a=this.$pane.children(".tabs").find("a");if(a.length){this.tabs={};for(var b=0;b<a.length;b++){var d=c(a[b]),e=d.attr("href");e&&"#"==e.charAt(0)&&(this.tabs[e]={$tab:d,$target:c(e)},this.addListener(d,"activate","selectTab"));!this.selectedTab&&d.hasClass("sel")&&(this.selectedTab=e)}document.location.hash&&
"undefined"!=typeof this.tabs[document.location.hash]?this.tabs[document.location.hash].$tab.trigger("activate"):this.selectedTab||c(a[0]).trigger("activate")}this.initContent()},selectTab:function(a){this.selectedTab&&a.currentTarget==this.tabs[this.selectedTab].$tab[0]||(this.deselectTab(),this.selectedTab=c(a.currentTarget).addClass("sel").attr("href"),a=this.tabs[this.selectedTab].$target,a.removeClass("hidden"),a.hasClass("content")&&(this.hasSidebar&&(this.removeListener(this.$content,"resize"),
this.removeListener(this.$sidebar,"resize"),this.removeListener(Garnish.$win,"scroll resize")),this.$content=a,this.initContent()),Garnish.$win.trigger("resize"))},deselectTab:function(){this.selectedTab&&(this.tabs[this.selectedTab].$tab.removeClass("sel"),this.tabs[this.selectedTab].$target.addClass("hidden"))},initContent:function(){if(this.hasSidebar=this.$content.hasClass("has-sidebar"))this.$sidebar=this.$content.children(".sidebar"),this.showingSidebar=!0,this.updateResponsiveSidebar(),this.addListener(this.$content,
"resize",function(){this.updateResponsiveSidebar();this.updateSidebarStyles()}),this.addListener(this.$sidebar,"resize","setMinContentSizeForSidebar"),this.setMinContentSizeForSidebar(),this.addListener(Garnish.$win,"scroll resize","updateSidebarStyles"),this.updateSidebarStyles()},updateResponsiveSidebar:function(){this.$content.width()+parseInt(this.$content.css("margin-"+Craft.left))<Craft.Pane.minContentWidthForSidebar?this.showingSidebar&&this.hideSidebar():this.showingSidebar||this.showSidebar()},
showSidebar:function(){this.$content.removeClass("hiding-sidebar");this.$sidebarBtn.remove();this.showingSidebar=!0;this.updateSidebarStyles();this.setMinContentSizeForSidebar();this.peekingSidebar&&this.stopPeeking()},hideSidebar:function(){this.$content.addClass("hiding-sidebar");this.$sidebarBtn=c('<a class="show-sidebar" title="'+Craft.t("Show sidebar")+'"></a>').appendTo(this.$content);this.addListener(this.$sidebarBtn,"click","togglePeekingSidebar");this.showingSidebar=!1;this.setMinContentSizeForSidebar()},
togglePeekingSidebar:function(){this.peekingSidebar?this.stopPeeking():this.startPeeking();this.setMinContentSizeForSidebar()},startPeeking:function(){this.$content.animateLeft(194,"fast");this.$sidebarBtn.addClass("showing").attr("title",Craft.t("Hide sidebar"));this.peekingSidebar=!0;this.updateSidebarStyles();this.addListener(this.$sidebar,"click",c.proxy(function(a){"A"==a.target.nodeName&&this.togglePeekingSidebar()},this))},stopPeeking:function(){this.$content.animateLeft(0,"fast");this.$sidebarBtn.removeClass("showing").attr("title",
Craft.t("Show sidebar"));this.peekingSidebar=!1;this.removeListener(this.$sidebar,"click")},setMinContentSizeForSidebar:function(){this.setMinContentSizeForSidebar._minHeight=this.showingSidebar||this.peekingSidebar?this.$sidebar.prop("scrollHeight")-48:0;this.$content.css("min-height",this.setMinContentSizeForSidebar._minHeight)},updateSidebarStyles:function(){if(this.showingSidebar||this.peekingSidebar)this.updateSidebarStyles._styles={},this.updateSidebarStyles._scrollTop=Garnish.$win.scrollTop(),
this.updateSidebarStyles._contentOffset=this.$content.offset().top,this.updateSidebarStyles._contentHeight=this.$content.height()-24,this.updateSidebarStyles._windowHeight=Garnish.$win.height(),this.updateSidebarStyles._styles.top=this.updateSidebarStyles._scrollTop>this.updateSidebarStyles._contentOffset-24?this.updateSidebarStyles._scrollTop-this.updateSidebarStyles._contentOffset:-24,this.updateSidebarStyles._styles.maxHeight=Math.min(this.updateSidebarStyles._contentHeight-this.updateSidebarStyles._styles.top,
this.updateSidebarStyles._windowHeight-48),0!=this.updateSidebarStyles._styles.top&&100>this.updateSidebarStyles._styles.maxHeight&&(this.updateSidebarStyles.newTop=Math.max(-24,this.updateSidebarStyles._styles.top-(100-this.updateSidebarStyles._styles.maxHeight)),this.updateSidebarStyles._styles.maxHeight+=this.updateSidebarStyles._styles.top-this.updateSidebarStyles.newTop,this.updateSidebarStyles._styles.top=this.updateSidebarStyles.newTop),this.$sidebar.css(this.updateSidebarStyles._styles)},
destroy:function(){this.base();this.$pane.data("pane",null)}},{minContentWidthForSidebar:514});Craft.PasswordInput=Garnish.Base.extend({$passwordInput:null,$textInput:null,$currentInput:null,$showPasswordToggle:null,showingPassword:null,init:function(a,b){this.$passwordInput=c(a);this.settings=c.extend({},Craft.PasswordInput.defaults,b);this.$passwordInput.data("passwordInput")&&(Garnish.log("Double-instantiating a password input on an element"),this.$passwordInput.data("passwordInput").destroy());
this.$passwordInput.data("passwordInput",this);this.$showPasswordToggle=c("<a/>").hide();this.$showPasswordToggle.addClass("password-toggle");this.$showPasswordToggle.insertAfter(this.$passwordInput);this.addListener(this.$showPasswordToggle,"mousedown","onToggleMouseDown");this.hidePassword()},setCurrentInput:function(a){this.$currentInput&&(a.addClass("focus"),this.$currentInput.replaceWith(a),a.focus(),a.removeClass("focus"),a.val(this.$currentInput.val()));this.$currentInput=a;this.addListener(this.$currentInput,
"keypress,keyup,change,blur","onInputChange")},updateToggleLabel:function(a){this.$showPasswordToggle.text(a)},showPassword:function(){this.showingPassword||(this.$textInput||(this.$textInput=this.$passwordInput.clone(!0),this.$textInput.attr("type","text")),this.setCurrentInput(this.$textInput),this.updateToggleLabel(Craft.t("Hide")),this.showingPassword=!0)},hidePassword:function(){!1!==this.showingPassword&&(this.setCurrentInput(this.$passwordInput),this.updateToggleLabel(Craft.t("Show")),this.showingPassword=
!1,this.addListener(this.$passwordInput,"keydown","onKeyDown"))},togglePassword:function(){this.showingPassword?this.hidePassword():this.showPassword();this.settings.onToggleInput(this.$currentInput)},onKeyDown:function(a){a.keyCode==Garnish.ALT_KEY&&this.$currentInput.val()&&(this.showPassword(),this.$showPasswordToggle.hide(),this.addListener(this.$textInput,"keyup","onKeyUp"))},onKeyUp:function(a){a.preventDefault();a.keyCode==Garnish.ALT_KEY&&(this.hidePassword(),this.$showPasswordToggle.show())},
onInputChange:function(){this.$currentInput.val()?this.$showPasswordToggle.show():this.$showPasswordToggle.hide()},onToggleMouseDown:function(a){a.preventDefault();if(this.$currentInput[0].setSelectionRange)var b=this.$currentInput[0].selectionStart,c=this.$currentInput[0].selectionEnd;this.togglePassword();this.$currentInput[0].setSelectionRange&&this.$currentInput[0].setSelectionRange(b,c)}},{defaults:{onToggleInput:c.noop}});Craft.ProgressBar=Garnish.Base.extend({$progressBar:null,$innerProgressBar:null,
_itemCount:0,_processedItemCount:0,init:function(a){this.$progressBar=c('<div class="progressbar pending hidden"/>').appendTo(a);this.$innerProgressBar=c('<div class="progressbar-inner"/>').appendTo(this.$progressBar);this.resetProgressBar()},resetProgressBar:function(){this.setProgressPercentage(100);this.$progressBar.addClass("pending");this.setItemCount(1);this.setProcessedItemCount(0)},hideProgressBar:function(){this.$progressBar.fadeTo("fast",0.01,c.proxy(function(){this.$progressBar.addClass("hidden").fadeTo(1,
1,c.noop)},this))},showProgressBar:function(){this.$progressBar.removeClass("hidden")},setItemCount:function(a){this._itemCount=a},incrementItemCount:function(a){this._itemCount+=a},setProcessedItemCount:function(a){this._processedItemCount=a},incrementProcessedItemCount:function(a){this._processedItemCount+=a},updateProgressBar:function(){this._itemCount=Math.max(this._itemCount,1);var a=Math.min(100,Math.round(100*this._processedItemCount/this._itemCount));this.setProgressPercentage(a)},setProgressPercentage:function(a,
b){0==a?this.$progressBar.addClass("pending"):(this.$progressBar.removeClass("pending"),b?this.$innerProgressBar.stop().animate({width:a+"%"},"fast"):this.$innerProgressBar.stop().width(a+"%"))}});Craft.PromptHandler=Garnish.Base.extend({$modalContainerDiv:null,$prompt:null,$promptApplyToRemainingContainer:null,$promptApplyToRemainingCheckbox:null,$promptApplyToRemainingLabel:null,$promptButtons:null,_prompts:[],_promptBatchCallback:c.noop,_promptBatchReturnData:[],_promptBatchNum:0,init:function(){},
resetPrompts:function(){this._prompts=[];this._promptBatchCallback=c.noop;this._promptBatchReturnData=[];this._promptBatchNum=0},addPrompt:function(a){this._prompts.push(a)},getPromptCount:function(){return this._prompts.length},showBatchPrompts:function(a){this._promptBatchCallback=a;this._promptBatchReturnData=[];this._promptBatchNum=0;this._showNextPromptInBatch()},_showNextPromptInBatch:function(){var a=this._prompts[this._promptBatchNum].prompt,b=this._prompts.length-(this._promptBatchNum+1);
this._showPrompt(a.message,a.choices,c.proxy(this,"_handleBatchPromptSelection"),b)},_handleBatchPromptSelection:function(a,b){var d=this._prompts.length-(this._promptBatchNum+1),e=c.extend(this._prompts[this._promptBatchNum],{choice:a});this._promptBatchReturnData.push(e);d?(this._promptBatchNum++,b?this._handleBatchPromptSelection(a,!0):this._showNextPromptInBatch()):"function"==typeof this._promptBatchCallback&&this._promptBatchCallback(this._promptBatchReturnData)},_showPrompt:function(a,b,d,
e){this._promptCallback=d;null==this.modal&&(this.modal=new Garnish.Modal({closeOtherModals:!1}));null==this.$modalContainerDiv&&(this.$modalContainerDiv=c('<div class="modal fitted prompt-modal"></div>').addClass().appendTo(Garnish.$bod));this.$prompt=c('<div class="body"></div>').appendTo(this.$modalContainerDiv.empty());this.$promptMessage=c('<p class="prompt-msg"/>').appendTo(this.$prompt);c("<p>").html(Craft.t("What do you want to do?")).appendTo(this.$prompt);this.$promptApplyToRemainingContainer=
c('<label class="assets-applytoremaining"/>').appendTo(this.$prompt).hide();this.$promptApplyToRemainingCheckbox=c('<input type="checkbox"/>').appendTo(this.$promptApplyToRemainingContainer);this.$promptApplyToRemainingLabel=c("<span/>").appendTo(this.$promptApplyToRemainingContainer);this.$promptButtons=c('<div class="buttons"/>').appendTo(this.$prompt);this.modal.setContainer(this.$modalContainerDiv);this.$promptMessage.html(a);for(a=0;a<b.length;a++)d=c('<div class="btn" data-choice="'+b[a].value+
'">'+b[a].title+"</div>"),this.addListener(d,"activate",function(a){a=a.currentTarget.getAttribute("data-choice");var b=this.$promptApplyToRemainingCheckbox.prop("checked");this._selectPromptChoice(a,b)}),this.$promptButtons.append(d);e&&(this.$promptApplyToRemainingContainer.show(),this.$promptApplyToRemainingLabel.html(" "+Craft.t("Apply this to the {number} remaining conflicts?",{number:e})));this.modal.show();this.modal.removeListener(Garnish.Modal.$shade,"click");this.addListener(Garnish.Modal.$shade,
"click","_cancelPrompt")},_selectPromptChoice:function(a,b){this.$prompt.fadeOut("fast",c.proxy(function(){this.modal.hide();this._promptCallback(a,b)},this))},_cancelPrompt:function(){this._selectPromptChoice("cancel",!0)}});Craft.SlugGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(a){a=a.replace(/<(.*?)>/g,"");a=a.replace(/['"\u2018\u2019\u201c\u201d\[\]\(\)\{\}:]/g,"");a=a.toLowerCase();a=Craft.filterArray(XRegExp.matchChain(a,[XRegExp("[\\p{L}\\p{N}\\.]+")]));return a.length?
a.join(Craft.slugWordSeparator):""}});Craft.Structure=Garnish.Base.extend({id:null,$container:null,state:null,structureDrag:null,init:function(a,b,d){this.id=a;this.$container=c(b);this.setSettings(d,Craft.Structure.defaults);this.$container.data("structure")&&(Garnish.log("Double-instantiating a structure on an element"),this.$container.data("structure").destroy());this.$container.data("structure",this);this.state={};this.settings.storageKey&&c.extend(this.state,Craft.getLocalStorage(this.settings.storageKey,
{}));"undefined"==typeof this.state.collapsedElementIds&&(this.state.collapsedElementIds=[]);a=this.$container.find("ul").prev(".row");for(b=0;b<a.length;b++){d=c(a[b]);var e=d.parent(),f=c('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(d);-1!=c.inArray(d.children(".element").data("id"),this.state.collapsedElementIds)&&e.addClass("collapsed");this.initToggle(f)}this.settings.sortable&&(this.structureDrag=new Craft.StructureDrag(this,this.settings.maxLevels));this.settings.newChildUrl&&
this.initNewChildMenus(this.$container.find(".add"))},initToggle:function(a){a.click(c.proxy(function(a){a=c(a.currentTarget).closest("li");var d=a.children(".row").find(".element:first").data("id"),e=c.inArray(d,this.state.collapsedElementIds);a.hasClass("collapsed")?(a.removeClass("collapsed"),-1!=e&&this.state.collapsedElementIds.splice(e,1)):(a.addClass("collapsed"),-1==e&&this.state.collapsedElementIds.push(d));this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.state)},
this))},initNewChildMenus:function(a){this.addListener(a,"click","onNewChildMenuClick")},onNewChildMenuClick:function(a){a=c(a.currentTarget);if(!a.data("menubtn")){var b=a.parent().children(".element").data("id"),b=Craft.getUrl(this.settings.newChildUrl,"parentId="+b);c('<div class="menu"><ul><li><a href="'+b+'">'+Craft.t("New child")+"</a></li></ul></div>").insertAfter(a);(new Garnish.MenuBtn(a)).showMenu()}},getIndent:function(a){return Craft.Structure.baseIndent+(a-1)*Craft.Structure.nestedIndent},
addElement:function(a){var b=c('<li data-level="1"/>').appendTo(this.$container),d=c('<div class="row" style="margin-'+Craft.left+": -"+Craft.Structure.baseIndent+"px; padding-"+Craft.left+": "+Craft.Structure.baseIndent+'px;">').appendTo(b);d.append(a);this.settings.sortable&&(d.append('<a class="move icon" title="'+Craft.t("Move")+'"></a>'),this.structureDrag.addItems(b));this.settings.newChildUrl&&(a=c('<a class="add icon" title="'+Craft.t("New Child")+'"></a>').appendTo(d),this.initNewChildMenus(a));
d.css("margin-bottom",-30);d.animate({"margin-bottom":0},"fast")},removeElement:function(a){var b=a.parent().parent();this.settings.sortable&&this.structureDrag.removeItems(b);if(!b.siblings().length)var d=b.parent();b.css("visibility","hidden").animate({marginBottom:-b.height()},"fast",c.proxy(function(){b.remove();"undefined"!=typeof d&&this._removeUl(d)},this))},_removeUl:function(a){a.siblings(".row").children(".toggle").remove();a.remove()}},{baseIndent:8,nestedIndent:35,defaults:{storageKey:null,
sortable:!1,newChildUrl:null,maxLevels:null}});Craft.StructureDrag=Garnish.Drag.extend({structure:null,maxLevels:null,draggeeLevel:null,$helperLi:null,$targets:null,draggeeHeight:null,init:function(a,b){this.structure=a;this.maxLevels=b;this.$insertion=c('<li class="draginsertion"/>');var d=this.structure.$container.find("li");this.base(d,{handle:".element:first, .move:first",helper:c.proxy(this,"getHelper")})},getHelper:function(a){this.$helperLi=a;var b=c('<ul class="structure draghelper"/>').append(a);
a.css("padding-"+Craft.left,this.$draggee.css("padding-"+Craft.left));a.find(".move").removeAttr("title");return b},onDragStart:function(){this.$targets=c();this.findTargets(this.structure.$container);this.draggeeLevel=0;var a=this.$draggee;do this.draggeeLevel++,a=a.find("> ul > li");while(a.length);this.draggeeHeight=this.$draggee.height();this.$draggee.animate({height:0},"fast",c.proxy(function(){this.$draggee.addClass("hidden")},this));this.base();this.addListener(Garnish.$doc,"keydown",function(a){a.keyCode==
Garnish.ESC_KEY&&this.cancelDrag()})},findTargets:function(a){a=a.children().not(this.$draggee);for(var b=0;b<a.length;b++){var d=c(a[b]);this.$targets=this.$targets.add(d.children(".row"));d.hasClass("collapsed")||this.findTargets(d.children("ul"))}},onDrag:function(){this._.$closestTarget&&(this._.$closestTarget.removeClass("draghover"),this.$insertion.remove());this._.$closestTarget=null;this._.closestTargetPos=null;this._.closestTargetYDiff=null;this._.closestTargetOffset=null;this._.closestTargetHeight=
null;for(this._.i=0;this._.i<this.$targets.length;this._.i++)if(this._.$target=c(this.$targets[this._.i]),this._.targetOffset=this._.$target.offset(),this._.targetHeight=this._.$target.outerHeight(),this._.targetYMidpoint=this._.targetOffset.top+this._.targetHeight/2,this._.targetYDiff=Math.abs(this.mouseY-this._.targetYMidpoint),0==this._.i||this.mouseY>=this._.targetOffset.top+5&&this._.targetYDiff<this._.closestTargetYDiff)this._.$closestTarget=this._.$target,this._.closestTargetPos=this._.i,this._.closestTargetYDiff=
this._.targetYDiff,this._.closestTargetOffset=this._.targetOffset,this._.closestTargetHeight=this._.targetHeight;else break;if(this._.$closestTarget)if(0==this._.closestTargetPos&&this.mouseY<this._.closestTargetOffset.top+5)this.$insertion.prependTo(this.structure.$container);else if(this._.$closestTargetLi=this._.$closestTarget.parent(),this._.closestTargetLevel=this._.$closestTargetLi.data("level"),this._.closestTargetPos<this.$targets.length-1?(this._.$nextTargetLi=c(this.$targets[this._.closestTargetPos+
1]).parent(),this._.nextTargetLevel=this._.$nextTargetLi.data("level")):(this._.$nextTargetLi=null,this._.nextTargetLevel=null),this._.hoveringBetweenRows=this.mouseY>=this._.closestTargetOffset.top+this._.closestTargetHeight-5,this._.$nextTargetLi&&this._.nextTargetLevel==this._.closestTargetLevel)this._.hoveringBetweenRows?(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel-1)&&this.$insertion.insertAfter(this._.$closestTargetLi):(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+
this.draggeeLevel)&&this._.$closestTarget.addClass("draghover");else if(this._.$nextTargetLi&&this._.nextTargetLevel>this._.closestTargetLevel){if(!this.maxLevels||this.maxLevels>=this._.nextTargetLevel+this.draggeeLevel-1)this._.hoveringBetweenRows?this.$insertion.insertBefore(this._.$nextTargetLi):(this._.$closestTarget.addClass("draghover"),this.$insertion.appendTo(this._.$closestTargetLi.children("ul")))}else if(this._.hoveringBetweenRows){this._.draggeeX=this.mouseX-this.targetItemMouseDiffX;
"rtl"==Craft.orientation&&(this._.draggeeX+=this.$helperLi.width());this._.$parentLis=this._.$closestTarget.parentsUntil(this.structure.$container,"li");this._.$closestParentLi=null;this._.closestParentLiXDiff=null;this._.closestParentLevel=null;for(this._.i=0;this._.i<this._.$parentLis.length;this._.i++)this._.$parentLi=c(this._.$parentLis[this._.i]),this._.parentLiX=this._.$parentLi.offset().left,"rtl"==Craft.orientation&&(this._.parentLiX+=this._.$parentLi.width()),this._.parentLiXDiff=Math.abs(this._.parentLiX-
this._.draggeeX),this._.parentLevel=this._.$parentLi.data("level"),(!this.maxLevels||this.maxLevels>=this._.parentLevel+this.draggeeLevel-1)&&(!this._.$closestParentLi||this._.parentLiXDiff<this._.closestParentLiXDiff&&(!this._.$nextTargetLi||this._.parentLevel>=this._.nextTargetLevel))&&(this._.$closestParentLi=this._.$parentLi,this._.closestParentLiXDiff=this._.parentLiXDiff,this._.closestParentLevel=this._.parentLevel);this._.$closestParentLi&&this.$insertion.insertAfter(this._.$closestParentLi)}else(!this.maxLevels||
this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass("draghover")},cancelDrag:function(){this.$insertion.remove();this._.$closestTarget&&this._.$closestTarget.removeClass("draghover");this.onMouseUp()},onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){var a=this.$draggee.siblings().length?null:this.$draggee.parent();if(this.$insertion.parent().length){var b=this.$insertion.next().add(this.$insertion.prev());
-1==c.inArray(this.$draggee[0],b)?(this.$insertion.replaceWith(this.$draggee),b=!0):(this.$insertion.remove(),b=!1)}else b=this._.$closestTargetLi.children("ul"),a&&b.length&&b[0]==a[0]?b=!1:(b.length?this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click"):(b=c('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget),this.structure.initToggle(b),b=c("<ul>").appendTo(this._.$closestTargetLi)),this.$draggee.appendTo(b),
b=!0);this._.$closestTarget.removeClass("draghover");b&&(a&&this.structure._removeUl(a),a=this.$draggee.parentsUntil(this.structure.$container,"li").length+1,a!=this.$draggee.data("level")&&(1==this.$draggee.data("level")?(b={},b["padding-"+Craft.left]=38,this.$helperLi.animate(b,"fast")):1==a&&(b={},b["padding-"+Craft.left]=Craft.Structure.baseIndent,this.$helperLi.animate(b,"fast")),this.setLevel(this.$draggee,a)),a={structureId:this.structure.id,elementId:this.$draggee.children(".row").children(".element").data("id"),
prevId:this.$draggee.prev().children(".row").children(".element").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").children(".element").data("id")},Craft.postActionRequest("structures/moveElement",a,function(a,b){"success"==b&&Craft.cp.displayNotice(Craft.t("New order saved."))}))}this.$draggee.stop().removeClass("hidden").animate({height:this.draggeeHeight},"fast",c.proxy(function(){this.$draggee.css("height","auto")},this));this.returnHelpersToDraggees();this.base()},
setLevel:function(a,b){a.data("level",b);var d=this.structure.getIndent(b),e={};e["margin-"+Craft.left]="-"+d+"px";e["padding-"+Craft.left]=d+"px";this.$draggee.children(".row").css(e);d=a.children("ul").children();for(e=0;e<d.length;e++)this.setLevel(c(d[e]),b+1)}});Craft.TagSelectInput=Craft.BaseElementSelectInput.extend({id:null,name:null,tagGroupId:null,sourceElementId:null,elementSort:null,searchTimeout:null,searchMenu:null,$container:null,$elementsContainer:null,$elements:null,$addTagInput:null,
$spinner:null,init:function(a,b,d,e){this.id=a;this.name=b;this.tagGroupId=d;this.sourceElementId=e;this.$container=c("#"+this.id);this.$elementsContainer=this.$container.children(".elements");this.$elements=this.$elementsContainer.children();this.$addTagInput=this.$container.children(".add").children(".text");this.$spinner=this.$addTagInput.next();this.totalElements=this.$elements.length;this.elementSelect=new Garnish.Select(this.$elements,{multi:!0,filter:":not(.delete)"});this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,
filter:c.proxy(function(){return this.elementSelect.getSelectedItems()},this),caboose:c('<div class="caboose"/>'),onSortChange:c.proxy(function(){this.elementSelect.resetItemOrder()},this)});this.initElements(this.$elements);this.addListener(this.$addTagInput,"textchange",c.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(c.proxy(this,"searchForTags"),500)},this));this.addListener(this.$addTagInput,"keypress",function(a){a.keyCode==Garnish.RETURN_KEY&&
(a.preventDefault(),this.searchMenu&&this.selectTag(this.searchMenu.$options[0]))});this.addListener(this.$addTagInput,"focus",function(){this.searchMenu&&this.searchMenu.show()});this.addListener(this.$addTagInput,"blur",function(){setTimeout(c.proxy(function(){this.searchMenu&&this.searchMenu.hide()},this),1)})},searchForTags:function(){this.searchMenu&&this.killSearchMenu();if(this.$addTagInput.val()){this.$spinner.removeClass("hidden");for(var a=[],b=0;b<this.$elements.length;b++){var d=c(this.$elements[b]).data("id");
d&&a.push(d)}this.sourceElementId&&a.push(this.sourceElementId);var e={search:this.$addTagInput.val(),tagGroupId:this.tagGroupId,excludeIds:a};Craft.postActionRequest("tags/searchForTags",e,c.proxy(function(a,b){this.$spinner.addClass("hidden");if("success"==b){for(var d=c('<div class="menu tagmenu"/>').appendTo(Garnish.$bod),k=c("<ul/>").appendTo(d),m=0;m<a.tags.length;m++){var l=c("<li/>").appendTo(k);c('<a data-icon="tag"/>').appendTo(l).text(a.tags[m].name).data("id",a.tags[m].id)}a.exactMatch||
(l=c("<li/>").appendTo(k),c('<a data-icon="+"/>').appendTo(l).text(e.search));k.find("> li:first-child > a").addClass("hover");this.searchMenu=new Garnish.Menu(d,{attachToElement:this.$addTagInput,onOptionSelect:c.proxy(this,"selectTag")});this.searchMenu.show()}},this))}else this.$spinner.addClass("hidden")},selectTag:function(a){var b=c(a);a=b.data("id");var b=b.text(),d=c('<div class="element removable" data-id="'+a+'" data-editable="1"/>').appendTo(this.$elementsContainer),e=c('<input type="hidden" name="'+
this.name+'[]" value="'+a+'"/>').appendTo(d);c('<a class="delete icon" title="'+Craft.t("Remove")+'"></a>').appendTo(d);c('<span class="label">'+b+"</span>").appendTo(d);var f=-(d.outerWidth()+10);this.$addTagInput.css("margin-"+Craft.left,f+"px");f={};f["margin-"+Craft.left]=0;this.$addTagInput.animate(f,"fast");this.$elements=this.$elements.add(d);this.totalElements++;this.initElements(d);this.killSearchMenu();this.$addTagInput.val("");this.$addTagInput.focus();a||(d.addClass("loading disabled"),
Craft.postActionRequest("tags/createTag",{groupId:this.tagGroupId,name:b},c.proxy(function(a,b){"success"==b&&a.success?(d.attr("data-id",a.id),e.val(a.id),d.removeClass("loading disabled")):(this.removeElement(d),"success"==b&&Craft.cp.displayError(Craft.t("An unknown error occurred.")))},this)))},killSearchMenu:function(){this.searchMenu.hide();this.searchMenu.destroy();this.searchMenu=null}});Craft.UpgradeModal=Garnish.Modal.extend({$container:null,$body:null,$compareScreen:null,$checkoutScreen:null,
$successScreen:null,$checkoutForm:null,$checkoutLogo:null,$checkoutPrice:null,$checkoutSubmitBtn:null,$checkoutSpinner:null,$checkoutFormError:null,$checkoutSecure:null,clearCheckoutFormTimeout:null,$ccNameInput:null,$ccNumInput:null,$ccMonthInput:null,$ccYearInput:null,$ccCvcInput:null,submittingPurchase:!1,editions:null,edition:null,init:function(a){this.$container=c('<div id="upgrademodal" class="modal loading"/>').appendTo(Garnish.$bod);this.base(this.$container,c.extend({resizable:!0},a));Craft.postActionRequest("app/getUpgradeModal",
c.proxy(function(a,d){this.$container.removeClass("loading");if("success"==d){if(a.success){this.editions=a.editions;this.$container.append(a.modalHtml);this.$compareScreen=this.$container.children("#upgrademodal-compare");this.$checkoutScreen=this.$container.children("#upgrademodal-checkout");this.$successScreen=this.$container.children("#upgrademodal-success");this.$checkoutLogo=this.$checkoutScreen.find(".logo:first");this.$checkoutPrice=this.$checkoutScreen.find(".price:first");this.$checkoutForm=
this.$checkoutScreen.find("form:first");this.$checkoutSubmitBtn=this.$checkoutForm.find(".submit:first");this.$checkoutSpinner=this.$checkoutForm.find(".spinner:first");this.$ccNameInput=this.$checkoutForm.find("#cc-name");this.$ccNumInput=this.$checkoutForm.find("#cc-num");this.$ccMonthInput=this.$checkoutForm.find("#cc-month");this.$ccYearInput=this.$checkoutForm.find("#cc-year");this.$ccCvcInput=this.$checkoutForm.find("#cc-cvc");this.$checkoutSecure=this.$checkoutScreen.find(".secure:first");
var e=this.$compareScreen.find(".buybtn");this.addListener(e,"click","onBuyBtnClick");e=this.$compareScreen.find(".btn.test");this.addListener(e,"click","onTestBtnClick");this.addListener(this.$checkoutForm,"submit","submitPurchase");e=this.$checkoutScreen.find("#upgrademodal-cancelcheckout");this.addListener(e,"click","cancelCheckout")}else e=a.error?a.error:Craft.t("An unknown error occurred."),this.$container.append('<div class="body">'+e+"</div>");c('<script type="text/javascript" src="https://js.stripe.com/v1/">\x3c/script>').appendTo(Garnish.$bod)}},
this))},onHide:function(){this.clearCheckoutFormInABit();this.base()},onBuyBtnClick:function(a){this.edition=c(a.currentTarget).data("edition");a=this.editions[this.edition];var b=this.getWidth();switch(this.edition){case 1:this.$checkoutLogo.attr("class","logo craftclient").text("Craft Client");break;case 2:this.$checkoutLogo.attr("class","logo craftpro").text("Craft Pro")}a.salePrice?this.$checkoutPrice.html('<span class="listedprice">'+a.formattedPrice+"</span> "+a.formattedSalePrice):this.$checkoutPrice.html(a.formattedPrice);
this.clearCheckoutFormTimeout&&clearTimeout(this.clearCheckoutFormTimeout);this.$compareScreen.stop().animateLeft(-b,"fast",c.proxy(function(){this.$compareScreen.addClass("hidden")},this));this.$checkoutScreen.stop().css(Craft.left,b).removeClass("hidden").animateLeft(0,"fast")},onTestBtnClick:function(a){a={edition:c(a.currentTarget).data("edition")};Craft.postActionRequest("app/testUpgrade",a,c.proxy(function(a,d){if("success"==d){var e=this.getWidth();this.$compareScreen.stop().animateLeft(-e,
"fast",c.proxy(function(){this.$compareScreen.addClass("hidden")},this));this.onUpgrade()}},this))},cancelCheckout:function(){var a=this.getWidth();this.$compareScreen.stop().removeClass("hidden").animateLeft(0,"fast");this.$checkoutScreen.stop().animateLeft(a,"fast",c.proxy(function(){this.$checkoutScreen.addClass("hidden")},this));this.clearCheckoutFormInABit()},submitPurchase:function(a){a.preventDefault();if(!this.submittingPurchase){this.cleanupCheckoutForm();a={name:this.$ccNameInput.val(),
number:this.$ccNumInput.val(),exp_month:this.$ccMonthInput.val(),exp_year:this.$ccYearInput.val(),cvc:this.$ccCvcInput.val()};var b=!0;a.name||(b=!1,this.$ccNameInput.addClass("error"));Stripe.validateCardNumber(a.number)||(b=!1,this.$ccNumInput.addClass("error"));Stripe.validateExpiry(a.exp_month,a.exp_year)||(b=!1,this.$ccMonthInput.addClass("error"),this.$ccYearInput.addClass("error"));Stripe.validateCVC(a.cvc)||(b=!1,this.$ccCvcInput.addClass("error"));b?(this.submittingPurchase=!0,this.$checkoutSubmitBtn.addClass("active"),
this.$checkoutSpinner.removeClass("hidden"),Stripe.setPublishableKey(Craft.UpgradeModal.stripeApiKey),Stripe.createToken(a,c.proxy(function(a,b){b.error?(this.onPurchaseResponse(),this.showError(b.error.message),Garnish.shake(this.$checkoutForm,"left")):Craft.postActionRequest("app/purchaseUpgrade",{ccTokenId:b.id,edition:this.edition,expectedPrice:this.editions[this.edition].salePrice?this.editions[this.edition].salePrice:this.editions[this.edition].price},c.proxy(this,"onPurchaseUpgrade"))},this))):
Garnish.shake(this.$checkoutForm,"left")}},onPurchaseResponse:function(){this.submittingPurchase=!1;this.$checkoutSubmitBtn.removeClass("active");this.$checkoutSpinner.addClass("hidden")},onPurchaseUpgrade:function(a,b){this.onPurchaseResponse();if("success"==b)if(a.success){var d=this.getWidth();this.$checkoutScreen.stop().animateLeft(-d,"fast",c.proxy(function(){this.$checkoutScreen.addClass("hidden")},this));this.onUpgrade()}else{if(a.errors){var d="",e;for(e in a.errors)d&&(d+="<br>"),d+=a.errors[e];
this.showError(d)}else d=Craft.t("An unknown error occurred.");Garnish.shake(this.$checkoutForm,"left")}},showError:function(a){this.$checkoutFormError=c('<p class="error centeralign">'+a+"</p>").insertBefore(this.$checkoutSecure)},onUpgrade:function(){this.$successScreen.css(Craft.left,this.getWidth()).removeClass("hidden").animateLeft(0,"fast");var a=this.$successScreen.find(".btn:first");this.addListener(a,"click",function(){location.reload()});this.trigger("upgrade")},cleanupCheckoutForm:function(){this.$checkoutForm.find(".error").removeClass("error");
this.$checkoutFormError&&(this.$checkoutFormError.remove(),this.$checkoutFormError=null)},clearCheckoutForm:function(){this.$ccNameInput.val("");this.$ccNumInput.val("");this.$ccMonthInput.val("");this.$ccYearInput.val("");this.$ccCvcInput.val("")},clearCheckoutFormInABit:function(){this.clearCheckoutFormTimeout=setTimeout(c.proxy(this,"clearCheckoutForm"),Craft.UpgradeModal.clearCheckoutFormTimeoutDuration)}},{stripeApiKey:"pk_J2nJpozDxit0V6wYuT8xSvCKArONs",clearCheckoutFormTimeoutDuration:3E4});
Craft.Uploader=Garnish.Base.extend({uploader:null,allowedKinds:null,_rejectedFiles:[],$element:null,_extensionList:null,_fileCounter:0,init:function(a,b){this._rejectedFiles=[];this.$element=a;this._extensionList=this.allowedKinds=null;this._fileCounter=0;b=c.extend({},this.defaultSettings,b);var d=b.events;delete b.events;b.allowedKinds&&b.allowedKinds.length&&("string"==typeof b.allowedKinds&&(b.allowedKinds=[b.allowedKinds]),this.allowedKinds=b.allowedKinds,delete b.allowedKinds,b.autoUpload=!1);
this.uploader=a.fileupload(b);for(var e in d)this.uploader.on(e,d[e]);null!=b.dropZone&&c(document).bind("drop dragover",function(a){a.preventDefault()});if(this.allowedKinds)this.uploader.on("fileuploadadd",c.proxy(this,"onFileAdd"))},setParams:function(a){this.uploader.fileupload("option",{formData:a})},getInProgress:function(){return this.uploader.fileupload("active")},isLastUpload:function(){return 1==this.getInProgress()},onFileAdd:function(a,b){a.stopPropagation();if(!this._extensionList){this._extensionList=
[];for(var d=0;d<this.allowedKinds.length;d++)for(var e=this.allowedKinds[d],f=0;f<Craft.fileKinds[e].length;f++)this._extensionList.push(Craft.fileKinds[e][f])}b.process().done(c.proxy(function(){var a=b.files[0],d=a.name.match(/\.([a-z0-4_]+)$/i)[1];-1<c.inArray(d.toLowerCase(),this._extensionList)?b.submit():this._rejectedFiles.push('"'+a.name+'"');++this._fileCounter==b.originalFiles.length&&(this._fileCounter=0,this.processErrorMessages())},this));return!0},processErrorMessages:function(){if(this._rejectedFiles.length){var a=
1==this._rejectedFiles.length?"The file {files} could not be uploaded. The allowed file kinds are: {kinds}.":"The files {files} could not be uploaded. The allowed file kinds are: {kinds}.",a=Craft.t(a,{files:this._rejectedFiles.join(", "),kinds:this.allowedKinds.join(", ")});this._rejectedFiles=[];alert(a)}},defaultSettings:{dropZone:null,pasteZone:null,fileInput:null,autoUpload:!0,sequentialUploads:!0,maxFileSize:Craft.maxUploadSize,alloweKinds:null,events:{}}});Craft.WrongEditionModal=Garnish.Modal.extend({upgradeModal:null,
init:function(a){this.base(a.removeClass("hidden"));this.$switchBtn=c("#wrongedition-switchbtn");this.$upgradeBtn=c("#wrongedition-upgradebtn");this.addListener(this.$switchBtn,"click","switchToLicensedEdition");this.addListener(this.$upgradeBtn,"click","showUpgradeModal")},show:function(){this.base();this.removeAllListeners(this.$shade);Garnish.escManager.unregister(this)},switchToLicensedEdition:function(){this.$switchBtn.addClass("disabled");this.$upgradeBtn.addClass("disabled");this.removeAllListeners(this.$switchBtn);
this.removeAllListeners(this.$upgradeBtn);Craft.postActionRequest("app/switchToLicensedEdition",c.proxy(function(a,b){location.reload()},this))},showUpgradeModal:function(){this.upgradeModal?this.upgradeModal.show():(this.upgradeModal=new Craft.UpgradeModal({closeOtherModals:!1}),this.upgradeModal.on("upgrade",c.proxy(function(){this.hide()},this)))}})})(jQuery);

//# sourceMappingURL=craft.min.map
